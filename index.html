<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile App</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      height: 100%;
      overflow-x: hidden;
    }

    html {
      height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .mobile-container {
      min-height: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: linear-gradient(135deg, #40E0D0 0%, #48D1CC 100%);
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border-radius: 0;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%);
      backdrop-filter: blur(20px);
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .header h1 {
      margin: 0;
      color: #ffffff;
      font-size: 26px;
      font-weight: 900;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      text-align: left;
      letter-spacing: -0.5px;
      flex: 1;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      color: #ffffff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .header-btn:active {
      transform: translateY(0);
    }

    .color-option:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .color-option:active {
      transform: scale(0.98);
    }

    .header .subtitle {
      margin: 0 0 20px 0;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      font-weight: 500;
      text-align: left;
      letter-spacing: 0.5px;
    }

    .header-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 12px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.06);
      padding: 24px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .info-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .info-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .info-value {
      font-size: 22px;
      color: #ffffff;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      line-height: 1.2;
    }

    .date-time {
      font-size: 19px;
      font-weight: 800;
      letter-spacing: -0.3px;
    }

    .balance-row {
      display: flex;
      gap: 20px;
    }

    .balance-column {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .balance-column:first-child::after {
      content: '';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 1px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
    }

    .balance-label-rotating {
      transition: opacity 0.3s ease;
    }

    .info-value {
      transition: opacity 0.3s ease;
    }

    .content {
      flex: 1;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
      position: relative;
    }

    .content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    .content-text {
      color: #ffffff;
      font-size: 19px;
      line-height: 1.6;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-weight: 500;
      letter-spacing: -0.2px;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 360px;
      margin-top: 20px;
    }

    .menu-item {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .menu-item:hover .menu-icon {
      transform: rotate(360deg);
    }

    .menu-item:active {
      transform: translateY(-1px);
    }

    .menu-item:active .menu-icon {
      transform: rotate(360deg) scale(0.95);
    }

    .menu-icon {
      font-size: 28px;
      margin-bottom: 6px;
      display: block;
      transition: transform 0.6s ease;
    }

    .menu-label {
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      letter-spacing: -0.1px;
      text-transform: uppercase;
    }

    .additional-section {
      width: 100%;
      max-width: 360px;
      margin-top: 20px;
      padding-bottom: 20px;
    }

    .section-item {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .section-item:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .section-label {
      color: #ffffff;
      font-size: 16px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    /* Menu Page Styles */
    .menu-page-content {
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
    }

    .page-header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
      gap: 16px;
    }

    .back-button {
      background: #ffffff;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: #000000;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .back-button:hover {
      background: #f5f5f5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .back-icon {
      font-size: 16px;
      font-weight: bold;
    }

    .page-title {
      color: #ffffff;
      font-size: 20px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      margin: 0;
      letter-spacing: 0.5px;
      flex: 1;
      text-align: right;
    }

    .page-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .page-section {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .page-section.compact {
      padding: 16px;
      border-radius: 12px;
    }

    .page-section h3 {
      color: #ffffff;
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 12px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .page-section p {
      color: rgba(255, 255, 255, 0.85);
      font-size: 14px;
      line-height: 1.5;
      margin: 0 0 20px 0;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px 16px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Student Page Styles */
    .school-info-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-row .info-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      font-weight: 600;
    }

    .info-row .info-value {
      color: #ffffff;
      font-size: 13px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .add-student-section {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      align-items: stretch;
    }

    .add-student-btn {
      background: #ffc107;
      border: 2px solid #ffb300;
      border-radius: 8px;
      padding: 10px 16px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      flex: 1;
    }

    .add-student-btn:hover {
      background: #ffb300;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
    }

    @keyframes colorChange {
      0%, 100% {
        background: #22c55e;
        border-color: #16a34a;
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
      }
      50% {
        background: #ef4444;
        border-color: #dc2626;
        box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
      }
    }

    .animated-button {
      animation: colorChange 2s ease-in-out infinite;
    }

    .animated-button:hover {
      animation-play-state: paused;
      transform: translateY(-2px);
    }

    .edit-student-btn {
      background: #ef4444;
      border: 2px solid #dc2626;
      border-radius: 8px;
      padding: 10px 16px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      flex: 1;
    }

    .edit-student-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    .add-icon {
      font-size: 14px;
      font-weight: bold;
    }

    .table-container {
      overflow: auto;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 400px;
      position: relative;
    }

    .table-container::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .table-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.4);
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.6);
    }

    .table-container::-webkit-scrollbar-corner {
      background: rgba(255, 255, 255, 0.1);
    }

    .student-table {
      width: 100%;
      min-width: 500px;
      border-collapse: collapse;
      font-size: 14px;
    }

    .student-table th {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-weight: 700;
      padding: 16px 12px;
      text-align: center;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
    }

    .student-table td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
      text-align: left;
    }

    .student-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .student-table tbody tr:last-child td {
      border-bottom: none;
    }

    .student-table th:first-child,
    .student-table td:first-child {
      text-align: center;
      width: 60px;
      min-width: 60px;
    }

    .student-table th:nth-child(2),
    .student-table td:nth-child(2) {
      width: 200px;
      min-width: 150px;
      text-align: left;
    }

    .student-table th:nth-child(3),
    .student-table td:nth-child(3) {
      width: 100px;
      min-width: 80px;
      text-align: left;
    }

    .student-table th:last-child,
    .student-table td:last-child {
      text-align: center;
      width: 80px;
      min-width: 60px;
    }

    /* Edit Form Styles */
    .edit-info-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: linear-gradient(135deg, #40E0D0 0%, #48D1CC 100%);
      border-radius: 16px;
      width: 100%;
      max-width: 350px;
      max-height: 80%;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9) translateY(20px);
      transition: all 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      background: rgba(255, 255, 255, 0.1);
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      color: #ffffff;
      font-size: 18px;
      font-weight: 800;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.5px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 6px 10px;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }

    .modal-body {
      padding: 0;
      overflow-y: auto;
      max-height: calc(80vh - 120px);
    }

    /* Tab Styles */
    .tab-container {
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tab-buttons {
      display: flex;
      padding: 0;
    }

    .tab-button {
      flex: 1;
      background: transparent;
      border: none;
      padding: 14px 18px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 3px solid transparent;
    }

    .tab-button.active {
      color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
      border-bottom-color: #ffffff;
    }

    .tab-button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.9);
    }

    .tab-content {
      padding: 20px;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Styles for Modal */
    .modal-form-group {
      margin-bottom: 16px;
    }

    .modal-form-label {
      display: block;
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .modal-form-input, .modal-form-select {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px 14px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .modal-form-input:focus, .modal-form-select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    .modal-form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .modal-form-select option {
      background: #40E0D0;
      color: #ffffff;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .modal-form-group {
      flex: 1;
    }

    /* Upload Area Styles */
    .upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 20px 12px;
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .upload-area:hover {
      border-color: rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.08);
    }

    .upload-area.dragover {
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
    }

    .upload-icon {
      font-size: 28px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
      display: block;
    }

    .upload-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .upload-subtext {
      color: rgba(255, 255, 255, 0.6);
      font-size: 11px;
      line-height: 1.3;
    }

    .file-input {
      display: none;
    }

    /* Modal Action Buttons */
    .modal-actions {
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid transparent;
    }

    .modal-btn-primary {
      background: #22c55e;
      border-color: #16a34a;
      color: #ffffff;
    }

    .modal-btn-primary:hover {
      background: #16a34a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.5);
    }

    .modal-btn-secondary {
      background: #ef4444;
      border-color: #dc2626;
      color: #ffffff;
    }

    .modal-btn-secondary:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
    }

    .transaction-type-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #808080;
      border: 2px solid #666666;
      color: #ffffff;
    }

    .transaction-type-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      background: #909090;
    }

    .transaction-type-btn.active-setor {
      background: #22c55e;
      border-color: #16a34a;
      color: #ffffff;
      box-shadow: 0 4px 16px rgba(34, 197, 94, 0.5);
    }

    .transaction-type-btn.active-tarik {
      background: #ef4444;
      border-color: #dc2626;
      color: #ffffff;
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.5);
    }

    .edit-info-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .edit-icon {
      font-size: 14px;
    }

    .school-edit-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      font-weight: 600;
    }

    .form-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px 16px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .form-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .save-btn, .cancel-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-transform: uppercase;
    }

    .save-btn {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #ffffff;
    }

    .save-btn:hover {
      background: rgba(34, 197, 94, 0.3);
      transform: translateY(-1px);
    }

    .cancel-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #ffffff;
    }

    .cancel-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-1px);
    }

    @media (max-width: 480px) {
      .mobile-container {
        max-width: 100%;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-btn {
        width: 100%;
        text-align: center;
      }

      .modal-content {
        max-width: 320px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="mobile-container">
   <header class="header">
    <div class="header-top">
     <h1 id="app-title">Aplikasi Saya</h1>
     <div class="header-buttons"><button class="header-btn" onclick="showPengaturan()" title="Pengaturan">‚è£</button> <button class="header-btn" onclick="showKeluar()" title="Keluar">‚ûú</button>
     </div>
    </div>
    <p class="subtitle" id="app-subtitle">SELAMAT DATANG</p>
    <div class="header-info">
     <div class="info-item">
      <div class="info-value date-time" id="current-date">
       01 Jan 2024
      </div>
     </div>
     <div class="info-item">
      <div class="balance-row">
       <div class="balance-column">
        <div class="info-label balance-label-rotating" id="balance-label">
         Saldo
        </div>
        <div class="info-value" id="current-balance">
         Rp 0
        </div>
       </div>
       <div class="balance-column">
        <div class="info-label">
         Keterangan
        </div>
        <div class="info-value" id="balance-description">
         -
        </div>
       </div>
      </div>
     </div>
    </div>
   </header><!-- Home Page -->
   <main class="content" id="home-page">
    <div class="menu-grid">
     <div class="menu-item" onclick="handleMenuClick('Siswa')">
      <div class="menu-icon">
       ‚òª
      </div>
      <div class="menu-label" id="menu-1">
       Siswa
      </div>
     </div>
     <div class="menu-item" onclick="handleMenuClick('Transaksi')">
      <div class="menu-icon">
       ‚õÉ
      </div>
      <div class="menu-label" id="menu-2">
       Transaksi
      </div>
     </div>
     <div class="menu-item" onclick="handleMenuClick('Saldo')">
      <div class="menu-icon">
       ñ†©
      </div>
      <div class="menu-label" id="menu-3">
       Saldo
      </div>
     </div>
     <div class="menu-item" onclick="handleMenuClick('Laporan')">
      <div class="menu-icon">
       ‚ùñ
      </div>
      <div class="menu-label" id="menu-4">
       Laporan
      </div>
     </div>
     <div class="menu-item" onclick="handleMenuClick('Unduh')">
      <div class="menu-icon">
       ‚ö°Ô∏é
      </div>
      <div class="menu-label" id="menu-5">
       Unduh
      </div>
     </div>
     <div class="menu-item" onclick="handleMenuClick('Kirim')">
      <div class="menu-icon">
       ‚åØ‚å≤
      </div>
      <div class="menu-label" id="menu-6">
       Kirim
      </div>
     </div>
    </div>
    <div class="additional-section">
     <div class="section-item" style="padding: 16px;">
      <div class="section-label" style="margin-bottom: 12px; font-size: 14px;">
       üèÜ 5 SISWA DENGAN SALDO TERTINGGI
      </div>
      <div id="top-5-students" style="display: flex; flex-direction: column; gap: 8px;"><!-- Top 5 students will be displayed here -->
      </div>
     </div>
    </div>
   </main><!-- Menu Pages -->
   <main class="content menu-page-content" id="menu-page" style="display: none;">
    <div class="page-header"><button class="back-button" onclick="goBack()"> <span class="back-icon">‚Üê</span> <span>Kembali</span> </button>
     <h2 class="page-title" id="page-title">HALAMAN MENU</h2>
    </div>
    <div class="page-content" id="page-content"><!-- Dynamic content will be loaded here -->
    </div>
   </main>
  </div><!-- Modal Transaksi Baru -->
  <div class="modal-overlay" id="newTransactionModal">
   <div class="modal-content" style="background: #ffffff;">
    <div class="modal-header" style="background: rgba(0, 0, 0, 0.05); border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
     <h3 class="modal-title" style="color: #000000; text-shadow: none;">TRANSAKSI BARU</h3><button class="modal-close" onclick="closeNewTransactionModal()" style="background: rgba(0, 0, 0, 0.1); border: 1px solid rgba(0, 0, 0, 0.2); color: #000000;">√ó</button>
    </div>
    <div class="modal-body">
     <div style="padding: 20px;">
      <form id="new-transaction-form">
       <div class="modal-form-group"><label class="modal-form-label" style="color: #000000;">Tanggal Transaksi</label> <input type="date" class="modal-form-input" id="new-transaction-date" required style="background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.2); color: #000000;">
       </div>
       <div class="modal-form-group"><label class="modal-form-label" style="color: #000000;">Pilih Siswa</label> <select class="modal-form-select" id="new-transaction-student" required style="background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.2); color: #000000;"> <option value="">-- Pilih Siswa --</option> </select>
       </div>
       <div class="modal-form-group"><label class="modal-form-label" style="color: #000000;">Jenis Transaksi</label>
        <div style="display: flex; gap: 12px; margin-top: 8px;"><button type="button" class="transaction-type-btn" id="setor-btn" onclick="selectTransactionType('setor')"> SETOR </button> <button type="button" class="transaction-type-btn" id="tarik-btn" onclick="selectTransactionType('tarik')"> TARIK </button>
        </div>
       </div>
       <div class="modal-form-group"><label class="modal-form-label" style="color: #000000;">Jumlah Uang</label> <input type="text" class="modal-form-input" id="new-transaction-amount" placeholder="Rp 0" oninput="formatRupiahInput(this)" style="background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.2); color: #000000;">
       </div>
      </form>
     </div>
    </div>
    <div class="modal-actions" style="background: rgba(0, 0, 0, 0.03); border-top: 1px solid rgba(0, 0, 0, 0.1);"><button class="modal-btn modal-btn-secondary" onclick="closeNewTransactionModal()" style="flex: 1;"> KEMBALI </button> <button class="modal-btn modal-btn-primary" onclick="saveNewTransaction()" style="flex: 1;"> PROSES </button>
    </div>
   </div>
  </div><!-- Modal Pengaturan -->
  <div class="modal-overlay" id="settingsModal">
   <div class="modal-content" style="background: #ffffff;">
    <div class="modal-header" style="background: rgba(0, 0, 0, 0.05); border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
     <h3 class="modal-title" style="color: #000000; text-shadow: none;">PENGATURAN APLIKASI</h3><button class="modal-close" onclick="closeSettingsModal()" style="background: rgba(0, 0, 0, 0.1); border: 1px solid rgba(0, 0, 0, 0.2); color: #000000;">√ó</button>
    </div>
    <div class="modal-body">
     <div style="padding: 20px;">
      <h4 style="color: #000000; font-size: 16px; font-weight: 700; margin-bottom: 16px; text-align: center;">PENGATURAN TAMPILAN</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"><!-- Hijau Tosca --> <button class="color-option" onclick="changeAppColor('#40E0D0', '#48D1CC', 'Hijau Tosca')" style="background: linear-gradient(135deg, #40E0D0 0%, #48D1CC 100%); border: 2px solid #40E0D0; border-radius: 8px; padding: 12px 8px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
        <div style="color: #ffffff; font-weight: 700; font-size: 11px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
         HIJAU TOSCA
        </div>
        <div id="check-tosca" style="position: absolute; top: 4px; right: 6px; font-size: 16px; display: none;">
         ‚úì
        </div></button> <!-- Biru Langit --> <button class="color-option" onclick="changeAppColor('#87CEEB', '#5DADE2', 'Biru Langit')" style="background: linear-gradient(135deg, #87CEEB 0%, #5DADE2 100%); border: 2px solid #87CEEB; border-radius: 8px; padding: 12px 8px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
        <div style="color: #ffffff; font-weight: 700; font-size: 11px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
         BIRU LANGIT
        </div>
        <div id="check-biru" style="position: absolute; top: 4px; right: 6px; font-size: 16px; display: none;">
         ‚úì
        </div></button> <!-- Pink Baby --> <button class="color-option" onclick="changeAppColor('#FFB6C1', '#FF69B4', 'Pink Baby')" style="background: linear-gradient(135deg, #FFB6C1 0%, #FF69B4 100%); border: 2px solid #FFB6C1; border-radius: 8px; padding: 12px 8px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
        <div style="color: #ffffff; font-weight: 700; font-size: 11px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
         PINK BABY
        </div>
        <div id="check-pink" style="position: absolute; top: 4px; right: 6px; font-size: 16px; display: none;">
         ‚úì
        </div></button> <!-- Hitam --> <button class="color-option" onclick="changeAppColor('#2C3E50', '#34495E', 'Hitam')" style="background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%); border: 2px solid #2C3E50; border-radius: 8px; padding: 12px 8px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
        <div style="color: #ffffff; font-weight: 700; font-size: 11px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
         HITAM
        </div>
        <div id="check-hitam" style="position: absolute; top: 4px; right: 6px; font-size: 16px; display: none;">
         ‚úì
        </div></button> <!-- Kuning --> <button class="color-option" onclick="changeAppColor('#FFD700', '#FFA500', 'Kuning')" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border: 2px solid #FFD700; border-radius: 8px; padding: 12px 8px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; grid-column: 1 / -1;">
        <div style="color: #ffffff; font-weight: 700; font-size: 11px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
         KUNING
        </div>
        <div id="check-kuning" style="position: absolute; top: 4px; right: 6px; font-size: 16px; display: none;">
         ‚úì
        </div></button>
      </div>
      <div style="margin-top: 20px; padding: 16px; background: rgba(0, 0, 0, 0.05); border-radius: 10px; text-align: center;">
       <div style="color: #666666; font-size: 13px; line-height: 1.5;"><strong>Warna Aktif:</strong> <span id="active-color-name" style="font-weight: 700; color: #000000;">Hijau Tosca</span>
       </div>
      </div><!-- Pengaturan Data Section -->
      <h4 style="color: #000000; font-size: 14px; font-weight: 700; margin: 20px 0 12px 0; text-align: center;">PENGATURAN DATA</h4>
      <div style="display: flex; flex-direction: column; gap: 8px;"><!-- Hapus Semua Data --> <button onclick="hapusSemuaData()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: 2px solid #dc2626; border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;"> <span style="font-size: 16px;">üóëÔ∏è</span> <span style="color: #ffffff; font-weight: 700; font-size: 12px; letter-spacing: 0.3px;">HAPUS SEMUA DATA</span> </button> <!-- Backup Data --> <button onclick="backupData()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: 2px solid #2563eb; border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;"> <span style="font-size: 16px;">üíæ</span> <span style="color: #ffffff; font-weight: 700; font-size: 12px; letter-spacing: 0.3px;">BACKUP DATA</span> </button> <!-- Restore Data --> <button onclick="document.getElementById('restore-file-input').click()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: 2px solid #16a34a; border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;"> <span style="font-size: 16px;">üì•</span> <span style="color: #ffffff; font-weight: 700; font-size: 12px; letter-spacing: 0.3px;">RESTORE DATA</span> </button> <input type="file" id="restore-file-input" accept=".json" style="display: none;" onchange="restoreData(event)">
      </div>
     </div>
    </div>
    <div class="modal-actions" style="background: rgba(0, 0, 0, 0.03); border-top: 1px solid rgba(0, 0, 0, 0.1);"><button class="modal-btn modal-btn-secondary" onclick="closeSettingsModal()" style="flex: 1;"> TUTUP </button>
    </div>
   </div>
  </div><!-- Modal Tambah Siswa -->
  <div class="modal-overlay" id="addStudentModal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title">TAMBAH SISWA</h3><button class="modal-close" onclick="closeAddStudentModal()">√ó</button>
    </div>
    <div class="modal-body"><!-- Tab Container -->
     <div class="tab-container">
      <div class="tab-buttons"><button class="tab-button active" onclick="switchTab('manual')">Manual</button> <button class="tab-button" onclick="switchTab('upload')">Upload</button>
      </div>
     </div><!-- Manual Tab Content -->
     <div class="tab-content active" id="manual-tab">
      <form id="manual-student-form">
       <div class="modal-form-group"><label class="modal-form-label">Nama Siswa</label> <input type="text" class="modal-form-input" id="student-name" placeholder="Masukkan nama siswa" required>
       </div>
       <div class="modal-form-group"><label class="modal-form-label">Kelas</label> <input type="text" class="modal-form-input" id="student-class" placeholder="Kelas akan terisi otomatis" readonly style="background: rgba(255, 255, 255, 0.05); cursor: not-allowed;">
       </div>
       <div class="modal-form-group"><label class="modal-form-label">Jenis Kelamin</label> <select class="modal-form-select" id="student-gender" required> <option value="">Pilih Jenis Kelamin</option> <option value="L">Laki-laki (L)</option> <option value="P">Perempuan (P)</option> </select>
       </div>
      </form>
     </div><!-- Upload Tab Content -->
     <div class="tab-content" id="upload-tab">
      <div class="upload-area" onclick="document.getElementById('file-upload').click()"><span class="upload-icon">üìÑ</span>
       <div class="upload-text">
        Klik untuk Upload File Excel
       </div>
       <div class="upload-subtext">
        Atau drag &amp; drop file Excel (.xlsx, .xls, .csv)<br><strong>Format yang dibaca: NAMA SISWA dan JENIS KELAMIN saja</strong><br>
         JK: L/P/Laki-laki/Perempuan (semua format diterima)
       </div><input type="file" id="file-upload" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
      </div>
      <div id="upload-preview" style="display: none;">
       <div class="modal-form-group"><label class="modal-form-label">Preview Data</label>
        <div id="preview-content" style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; max-height: 200px; overflow-y: auto;"><!-- Preview content will be shown here -->
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="modal-actions"><button class="modal-btn modal-btn-secondary" onclick="closeAddStudentModal()">Batal</button> <button class="modal-btn modal-btn-primary" onclick="saveStudent()">Simpan</button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "TABUNGAN SISWA",
      app_subtitle: "SELAMAT DATANG",
      main_text: "Konten aplikasi Anda di sini",
      current_balance: "Rp 0",
      balance_description: "-",
      menu_1: "Siswa",
      menu_2: "Transaksi", 
      menu_3: "Saldo",
      menu_4: "Laporan",
      menu_5: "Unduh",
      menu_6: "Kirim",
      background_color: "#40E0D0",
      text_color: "#ffffff",
      accent_color: "#48D1CC"
    };

    // Function to get current date and time in Indonesian format
    function getCurrentDateTime() {
      const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
      const months = [
        'JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI',
        'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'
      ];
      const now = new Date();
      const dayName = days[now.getDay()];
      const day = now.getDate().toString().padStart(2, '0');
      const month = months[now.getMonth()];
      const year = now.getFullYear();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      return `${dayName} ${day} ${month} ${year} | ${hours}:${minutes}`;
    }

    // Rotating subtitle variables
    let subtitleIndex = 0;
    let subtitleInterval = null;
    
    // Rotating saldo variables
    let saldoIndex = 0;
    let saldoInterval = null;

    async function onConfigChange(config) {
      const appTitle = config.app_title || defaultConfig.app_title;
      const appSubtitle = config.app_subtitle || defaultConfig.app_subtitle;
      const mainText = config.main_text || defaultConfig.main_text;
      const currentBalance = config.current_balance || defaultConfig.current_balance;
      const balanceDescription = config.balance_description || defaultConfig.balance_description;
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      // Always use "TABUNGAN SISWA" as the title
      document.getElementById('app-title').textContent = "TABUNGAN SISWA";
      document.getElementById('main-text').textContent = mainText;
      document.getElementById('current-balance').textContent = currentBalance;
      document.getElementById('balance-description').textContent = balanceDescription;
      document.getElementById('current-date').textContent = getCurrentDateTime();
      
      // Start rotating subtitle
      startRotatingSubtitle();
      
      // Start rotating saldo
      startRotatingSaldo();

      // Update menu labels
      for (let i = 1; i <= 6; i++) {
        const menuElement = document.getElementById(`menu-${i}`);
        if (menuElement) {
          menuElement.textContent = config[`menu_${i}`] || defaultConfig[`menu_${i}`];
        }
      }

      const container = document.querySelector('.mobile-container');
      container.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${accentColor} 100%)`;

      const allText = document.querySelectorAll('.header h1, .content-text, .info-value, .info-label, .menu-label');
      allText.forEach(el => {
        el.style.color = textColor;
      });
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ background_color: value });
              }
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ accent_color: value });
              }
            }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["app_subtitle", config.app_subtitle || defaultConfig.app_subtitle],
        ["current_balance", config.current_balance || defaultConfig.current_balance],
        ["balance_description", config.balance_description || defaultConfig.balance_description],
        ["main_text", config.main_text || defaultConfig.main_text],
        ["menu_1", config.menu_1 || defaultConfig.menu_1],
        ["menu_2", config.menu_2 || defaultConfig.menu_2],
        ["menu_3", config.menu_3 || defaultConfig.menu_3],
        ["menu_4", config.menu_4 || defaultConfig.menu_4],
        ["menu_5", config.menu_5 || defaultConfig.menu_5],
        ["menu_6", config.menu_6 || defaultConfig.menu_6]
      ]);
    }

    // Navigation state
    let currentPage = 'home';
    
    // Transaction data storage
    let allTransactions = [];
    let studentBalances = {};
    
    // Persistent data storage
    let schoolInfo = {
      schoolName: '-',
      className: '-',
      teacherName: '-'
    };
    let studentsList = [];
    
    // Load data from localStorage on page load
    function loadPersistedData() {
      const savedSchoolInfo = localStorage.getItem('schoolInfo');
      if (savedSchoolInfo) {
        schoolInfo = JSON.parse(savedSchoolInfo);
      }
      
      const savedStudents = localStorage.getItem('studentsList');
      if (savedStudents) {
        studentsList = JSON.parse(savedStudents);
      }
      
      const savedTransactions = localStorage.getItem('allTransactions');
      if (savedTransactions) {
        allTransactions = JSON.parse(savedTransactions);
      }
      
      const savedBalances = localStorage.getItem('studentBalances');
      if (savedBalances) {
        studentBalances = JSON.parse(savedBalances);
      }
    }
    
    // Save data to localStorage
    function savePersistedData() {
      localStorage.setItem('schoolInfo', JSON.stringify(schoolInfo));
      localStorage.setItem('studentsList', JSON.stringify(studentsList));
      localStorage.setItem('allTransactions', JSON.stringify(allTransactions));
      localStorage.setItem('studentBalances', JSON.stringify(studentBalances));
    }

    // Handle menu click - navigate to specific page
    function handleMenuClick(menuName) {
      currentPage = menuName.toLowerCase();
      showPage(currentPage);
    }

    // Show specific page
    function showPage(pageName) {
      // Hide all pages first
      document.getElementById('home-page').style.display = 'none';
      document.getElementById('menu-page').style.display = 'none';
      
      // Show/hide header based on page
      const header = document.querySelector('.header');

      if (pageName === 'home') {
        document.getElementById('home-page').style.display = 'flex';
        header.style.display = 'block';
        document.getElementById('app-title').textContent = window.elementSdk?.config?.app_title || defaultConfig.app_title;
        
        // Restart rotating saldo when returning to home page
        startRotatingSaldo();
      } else {
        document.getElementById('menu-page').style.display = 'flex';
        header.style.display = 'none';
        // Update page title based on selected menu
        const pageTitle = getPageTitle(pageName);
        document.getElementById('page-title').textContent = pageTitle;
        document.getElementById('page-content').innerHTML = getPageContent(pageName);
        
        // Load persisted data after page content is rendered
        if (pageName === 'siswa') {
          setTimeout(() => {
            loadSchoolInfoToDisplay();
            loadStudentsToTable();
          }, 50);
        }
        
        // Set today's date automatically when opening transaction page
        if (pageName === 'transaksi') {
          setTimeout(setTodayDateFilter, 100);
        }
        
        // Calculate and display saldo when opening saldo page
        if (pageName === 'saldo') {
          setTimeout(calculateAndDisplaySaldo, 100);
        }
        
        // Load laporan data when opening laporan page
        if (pageName === 'laporan') {
          setTimeout(loadRiwayatData, 100);
        }
        
        // Set default period when opening unduh page
        if (pageName === 'unduh') {
          setTimeout(setDefaultUnduhPeriod, 100);
        }
        
        // Set default period when opening kirim page
        if (pageName === 'kirim') {
          setTimeout(setDefaultKirimPeriod, 100);
        }
      }
    }

    // Get page title based on menu name
    function getPageTitle(menuName) {
      const titles = {
        'siswa': 'SISWA',
        'transaksi': 'HALAMAN TRANSAKSI',
        'saldo': 'HALAMAN SALDO',
        'laporan': 'HALAMAN LAPORAN',
        'unduh': 'HALAMAN UNDUH',
        'kirim': 'HALAMAN KIRIM'
      };
      return titles[menuName] || 'HALAMAN MENU';
    }

    // Get page content based on menu name
    function getPageContent(menuName) {
      const contents = {
        'siswa': `
          <div class="page-section compact">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; font-size: 16px;">üè†Ô∏é Informasi Sekolah</h3>
              <button class="edit-info-btn" onclick="toggleEditMode()">
                <span class="edit-icon">‚úèÔ∏è</span>
                <span id="edit-btn-text">EDIT</span>
              </button>
            </div>
            
            <!-- Display Mode -->
            <div class="school-info-grid" id="display-mode">
              <div class="info-row">
                <span class="info-label">Nama Sekolah:</span>
                <span class="info-value" id="display-school-name">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">Kelas:</span>
                <span class="info-value" id="display-class">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">Wali Kelas:</span>
                <span class="info-value" id="display-teacher">-</span>
              </div>
            </div>
            
            <!-- Edit Mode -->
            <div class="school-edit-form" id="edit-mode" style="display: none;">
              <div class="form-group">
                <label class="form-label">Nama Sekolah:</label>
                <input type="text" class="form-input" id="edit-school-name" placeholder="Masukkan nama sekolah">
              </div>
              <div class="form-group">
                <label class="form-label">Kelas:</label>
                <input type="text" class="form-input" id="edit-class" placeholder="Masukkan kelas">
              </div>
              <div class="form-group">
                <label class="form-label">Wali Kelas:</label>
                <input type="text" class="form-input" id="edit-teacher" placeholder="Masukkan nama wali kelas">
              </div>
              <div class="form-buttons">
                <button class="save-btn" onclick="saveSchoolInfo()">
                  <span>üíæ</span>
                  <span>SIMPAN</span>
                </button>
                <button class="cancel-btn" onclick="cancelEdit()">
                  <span>‚ùå</span>
                  <span>BATAL</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="page-section">
            <div class="add-student-section">
              <button class="add-student-btn" onclick="showAddStudentForm()">
                <span class="add-icon">+</span>
                <span>TAMBAH SISWA</span>
              </button>
              <button class="edit-student-btn" onclick="showEditStudentForm()">
                <span class="edit-icon">‚úèÔ∏è</span>
                <span>EDIT SISWA</span>
              </button>
            </div>
          </div>
          
          <div class="page-section">
            <h3 style="text-align: left;">‚òª DAFTAR SISWA</h3>
            <div class="table-container">
              <table class="student-table">
                <thead>
                  <tr>
                    <th>NO</th>
                    <th>NAMA</th>
                    <th>KELAS</th>
                    <th>JK</th>
                  </tr>
                </thead>
                <tbody id="student-table-body">
                  <!-- Data siswa akan ditampilkan di sini -->
                </tbody>
              </table>
            </div>
          </div>
        `,
        'transaksi': `
          <div class="page-section compact">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <input type="date" class="modal-form-input" id="transaction-date-filter" onchange="filterTransactionsByDate()" style="width: 100%;">
              </div>
              <div style="display: flex; gap: 8px; align-items: flex-end;">
                <button class="add-student-btn animated-button" onclick="showNewTransactionModal()" style="padding: 10px 16px; white-space: nowrap;">
                  <span class="add-icon">+</span>
                  <span>TRANSAKSI BARU</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="page-section">
            <h3 style="text-align: left; margin-bottom: 16px;">üí∞ DAFTAR TRANSAKSI</h3>
            <div class="table-container">
              <table class="student-table">
                <thead>
                  <tr>
                    <th style="width: 50px; min-width: 40px; text-align: center;">NO</th>
                    <th style="width: 150px; min-width: 120px; text-align: left;">NAMA</th>
                    <th style="width: 100px; min-width: 80px; text-align: right;">SETOR</th>
                    <th style="width: 100px; min-width: 80px; text-align: right;">TARIK</th>
                    <th style="width: 100px; min-width: 80px; text-align: right;">SALDO</th>
                    <th style="width: 80px; min-width: 60px; text-align: center;">EDIT</th>
                  </tr>
                </thead>
                <tbody id="transaction-table-body">
                  <tr>
                    <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
                      Belum ada transaksi. Klik "+ TRANSAKSI BARU" untuk menambah transaksi.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        `,
        'saldo': `
          <div class="page-section compact">
            <h3 style="text-align: center; margin-bottom: 8px; font-size: 14px; letter-spacing: 1px;">üìä SALDO HARI INI</h3>
            <div style="text-align: center; margin-bottom: 12px;">
              <div style="font-size: 13px; color: rgba(255, 255, 255, 0.9); font-weight: 700; letter-spacing: 0.3px;" id="saldo-date-display">-</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Setor</div>
                <div style="font-size: 15px; color: #22c55e; font-weight: 800;" id="setor-today">Rp 0</div>
              </div>
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Tarik</div>
                <div style="font-size: 15px; color: #ef4444; font-weight: 800;" id="tarik-today">Rp 0</div>
              </div>
            </div>
            <div style="background: #ffffff; border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
              <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Saldo Hari Ini</div>
              <div style="font-size: 17px; color: #000000; font-weight: 900;" id="saldo-today">Rp 0</div>
            </div>
          </div>

          <div class="page-section compact">
            <h3 style="text-align: center; margin-bottom: 12px; font-size: 14px; letter-spacing: 1px;">üìÖ SALDO BULAN INI</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Setor</div>
                <div style="font-size: 15px; color: #22c55e; font-weight: 800;" id="setor-month">Rp 0</div>
              </div>
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Tarik</div>
                <div style="font-size: 15px; color: #ef4444; font-weight: 800;" id="tarik-month">Rp 0</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div style="background: #ffffff; border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Saldo Bulan Ini</div>
                <div style="font-size: 15px; color: #000000; font-weight: 900;" id="saldo-month">Rp 0</div>
              </div>
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Jumlah Transaksi</div>
                <div style="font-size: 15px; color: #000000; font-weight: 800;" id="transaction-count-month">0</div>
              </div>
            </div>
          </div>

          <div class="page-section compact">
            <h3 style="text-align: center; margin-bottom: 12px; font-size: 14px; letter-spacing: 1px;">üí∞ SALDO AKHIR</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Setor</div>
                <div style="font-size: 15px; color: #22c55e; font-weight: 800;" id="setor-total">Rp 0</div>
              </div>
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Tarik</div>
                <div style="font-size: 15px; color: #ef4444; font-weight: 800;" id="tarik-total">Rp 0</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div style="background: #ffffff; border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Saldo</div>
                <div style="font-size: 17px; color: #000000; font-weight: 900;" id="saldo-total">Rp 0</div>
              </div>
              <div style="background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 10px; color: #666666; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Siswa Aktif</div>
                <div style="font-size: 15px; color: #000000; font-weight: 800;" id="active-students">0</div>
              </div>
            </div>
          </div>
        `,
        'laporan': `
          <div class="page-section" style="padding: 0; overflow: hidden;">
            <!-- Tab Container -->
            <div class="tab-container">
              <div class="tab-buttons">
                <button class="tab-button active" onclick="switchLaporanTab('riwayat')">RIWAYAT</button>
                <button class="tab-button" onclick="switchLaporanTab('rekap')">REKAP</button>
              </div>
            </div>
            
            <!-- Riwayat Tab Content -->
            <div class="tab-content active" id="riwayat-tab" style="padding: 20px;">
              <h3 style="text-align: left; margin-bottom: 16px;">üìã FILTER RIWAYAT</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div>
                  <label class="modal-form-label" style="display: block; margin-bottom: 8px;">Bulan:</label>
                  <select class="modal-form-select" id="riwayat-month-filter" onchange="filterRiwayatByMonthYear()">
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                  </select>
                </div>
                <div>
                  <label class="modal-form-label" style="display: block; margin-bottom: 8px;">Tahun:</label>
                  <select class="modal-form-select" id="riwayat-year-filter" onchange="filterRiwayatByMonthYear()">
                  </select>
                </div>
              </div>
              
              <h3 style="text-align: center; margin-bottom: 16px; font-size: 16px; letter-spacing: 1px;">üìã RIWAYAT TRANSAKSI</h3>
              
              <div class="table-container" style="max-height: 400px; background: #ffffff; border: 2px solid #000000;">
                <table class="student-table" id="riwayat-table" style="background: #ffffff;">
                  <thead>
                    <tr>
                      <th style="width: 120px; min-width: 100px; position: sticky; left: 0; background: #ffffff; z-index: 10; color: #000000; border: 1px solid #000000;">NAMA</th>
                      <!-- Date columns will be generated dynamically -->
                    </tr>
                  </thead>
                  <tbody id="riwayat-table-body">
                    <tr>
                      <td colspan="32" style="text-align: center; color: #666666; padding: 40px; background: #ffffff;">
                        Pilih bulan dan tahun untuk melihat riwayat transaksi.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Rekap Tab Content -->
            <div class="tab-content" id="rekap-tab" style="padding: 20px;">
              <h3 style="text-align: left; margin-bottom: 16px;">üìã FILTER RIWAYAT</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div>
                  <label class="modal-form-label" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9);">Bulan:</label>
                  <select class="modal-form-select" id="rekap-month-filter" onchange="filterRekapByMonthYear()">
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                  </select>
                </div>
                <div>
                  <label class="modal-form-label" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9);">Tahun:</label>
                  <select class="modal-form-select" id="rekap-year-filter" onchange="filterRekapByMonthYear()">
                  </select>
                </div>
              </div>
              
              <h3 style="text-align: center; margin-bottom: 16px; font-size: 16px; letter-spacing: 1px; color: rgba(255, 255, 255, 0.95);">üìä REKAP TRANSAKSI</h3>
              
              <div class="table-container" style="background: #ffffff; border: 2px solid #000000;">
                <table class="student-table" id="rekap-table" style="background: #ffffff;">
                  <thead>
                    <tr>
                      <th style="width: 150px; min-width: 120px; background: #ffffff; color: #000000; border: 1px solid #000000;">NAMA</th>
                      <th style="width: 110px; min-width: 110px; background: #ffffff; color: #000000; border: 1px solid #000000;">TOTAL SETOR</th>
                      <th style="width: 110px; min-width: 110px; background: #ffffff; color: #000000; border: 1px solid #000000;">TOTAL TARIK</th>
                      <th style="width: 110px; min-width: 110px; background: #ffffff; color: #000000; border: 1px solid #000000;">SALDO BULAN INI</th>
                      <th style="width: 110px; min-width: 110px; background: #ffffff; color: #000000; border: 1px solid #000000;">SALDO AKHIR</th>
                    </tr>
                  </thead>
                  <tbody id="rekap-table-body">
                    <tr>
                      <td colspan="5" style="text-align: center; color: #666666; padding: 40px; background: #ffffff;">
                        Pilih bulan dan tahun untuk melihat rekap transaksi.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        'unduh': `
          <div class="page-section compact">
            <h3 style="text-align: left; margin-bottom: 16px;">üìã PILIH PERIODE</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
              <div>
                <label class="modal-form-label" style="display: block; margin-bottom: 8px;">Bulan:</label>
                <select class="modal-form-select" id="unduh-month-filter" onchange="handleUnduhMonthChange()">
                  <option value="all">SEMUA DATA</option>
                  <option value="0">Januari</option>
                  <option value="1">Februari</option>
                  <option value="2">Maret</option>
                  <option value="3">April</option>
                  <option value="4">Mei</option>
                  <option value="5">Juni</option>
                  <option value="6">Juli</option>
                  <option value="7">Agustus</option>
                  <option value="8">September</option>
                  <option value="9">Oktober</option>
                  <option value="10">November</option>
                  <option value="11">Desember</option>
                </select>
              </div>
              <div>
                <label class="modal-form-label" style="display: block; margin-bottom: 8px;">Tahun:</label>
                <select class="modal-form-select" id="unduh-year-filter">
                  <option value="all">SEMUA DATA</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                  <option value="2028">2028</option>
                  <option value="2029">2029</option>
                  <option value="2030">2030</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="page-section">
            <h3 style="text-align: left; margin-bottom: 16px;">üìÑ UNDUH RIWAYAT</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
              <button class="action-btn" onclick="unduhRiwayatPDF()" style="background: #ef4444; border: 2px solid #dc2626; color: #ffffff; font-weight: 700; padding: 14px 12px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: column;">
                <span style="font-size: 18px;">üìÑ</span>
                <span style="font-size: 11px;">PDF</span>
              </button>
              <button class="action-btn" onclick="unduhRiwayatXLSX()" style="background: #22c55e; border: 2px solid #16a34a; color: #ffffff; font-weight: 700; padding: 14px 12px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: column;">
                <span style="font-size: 18px;">üìä</span>
                <span style="font-size: 11px;">XLSX</span>
              </button>
              <button class="action-btn" onclick="unduhRiwayatCSV()" style="background: #3b82f6; border: 2px solid #2563eb; color: #ffffff; font-weight: 700; padding: 14px 12px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: column;">
                <span style="font-size: 18px;">üìã</span>
                <span style="font-size: 11px;">CSV</span>
              </button>
            </div>
          </div>
          
          <div class="page-section">
            <h3 style="text-align: left; margin-bottom: 16px;">üìä UNDUH REKAP</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
              <button class="action-btn" onclick="unduhRekapPDF()" style="background: #ef4444; border: 2px solid #dc2626; color: #ffffff; font-weight: 700; padding: 14px 12px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: column;">
                <span style="font-size: 18px;">üìÑ</span>
                <span style="font-size: 11px;">PDF</span>
              </button>
              <button class="action-btn" onclick="unduhRekapXLSX()" style="background: #22c55e; border: 2px solid #16a34a; color: #ffffff; font-weight: 700; padding: 14px 12px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: column;">
                <span style="font-size: 18px;">üìä</span>
                <span style="font-size: 11px;">XLSX</span>
              </button>
              <button class="action-btn" onclick="unduhRekapCSV()" style="background: #3b82f6; border: 2px solid #2563eb; color: #ffffff; font-weight: 700; padding: 14px 12px; display: flex; align-items: center; justify-content: center; gap: 6px; flex-direction: column;">
                <span style="font-size: 18px;">üìã</span>
                <span style="font-size: 11px;">CSV</span>
              </button>
            </div>
          </div>
        `,
        'kirim': `
          <div class="page-section compact">
            <h3 style="text-align: left; margin-bottom: 16px;">üìã PILIH PERIODE</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
              <div>
                <label class="modal-form-label" style="display: block; margin-bottom: 8px;">Bulan:</label>
                <select class="modal-form-select" id="kirim-month-filter" onchange="handleKirimMonthChange()">
                  <option value="all">SEMUA DATA</option>
                  <option value="0">Januari</option>
                  <option value="1">Februari</option>
                  <option value="2">Maret</option>
                  <option value="3">April</option>
                  <option value="4">Mei</option>
                  <option value="5">Juni</option>
                  <option value="6">Juli</option>
                  <option value="7">Agustus</option>
                  <option value="8">September</option>
                  <option value="9">Oktober</option>
                  <option value="10">November</option>
                  <option value="11">Desember</option>
                </select>
              </div>
              <div>
                <label class="modal-form-label" style="display: block; margin-bottom: 8px;">Tahun:</label>
                <select class="modal-form-select" id="kirim-year-filter">
                  <option value="all">SEMUA DATA</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                  <option value="2028">2028</option>
                  <option value="2029">2029</option>
                  <option value="2030">2030</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="page-section">
            <h3 style="text-align: left; margin-bottom: 16px;">üìß KIRIM LAPORAN</h3>
            <p style="color: rgba(255, 255, 255, 0.85); font-size: 14px; line-height: 1.5; margin: 0 0 20px 0;">
              Kirim laporan rekap transaksi ke email atau WhatsApp
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <button class="action-btn" onclick="kirimViaEmail()" style="background: #ef4444; border: 2px solid #dc2626; color: #ffffff; font-weight: 700; padding: 16px 12px; display: flex; align-items: center; justify-content: center; gap: 8px; flex-direction: column;">
                <span style="font-size: 24px;">üìß</span>
                <span style="font-size: 13px;">EMAIL</span>
              </button>
              <button class="action-btn" onclick="kirimViaWhatsApp()" style="background: #22c55e; border: 2px solid #16a34a; color: #ffffff; font-weight: 700; padding: 16px 12px; display: flex; align-items: center; justify-content: center; gap: 8px; flex-direction: column;">
                <span style="font-size: 24px;">üí¨</span>
                <span style="font-size: 13px;">WHATSAPP</span>
              </button>
            </div>
          </div>
        `
      };
      return contents[menuName] || '<p>Konten halaman akan ditampilkan di sini.</p>';
    }

    // Go back to home page
    function goBack() {
      currentPage = 'home';
      showPage('home');
    }

    // Show add student form modal
    function showAddStudentForm() {
      const modal = document.getElementById('addStudentModal');
      modal.classList.add('active');
      
      // Reset form
      document.getElementById('manual-student-form').reset();
      document.getElementById('upload-preview').style.display = 'none';
      
      // Auto-fill kelas from persistent storage
      document.getElementById('student-class').value = schoolInfo.className;
      
      // Switch to manual tab by default
      switchTab('manual');
    }

    // Close add student modal
    function closeAddStudentModal() {
      const modal = document.getElementById('addStudentModal');
      modal.classList.remove('active');
    }

    // Switch between tabs
    function switchTab(tabName) {
      // Remove active class from all tabs and buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and button
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Save student data
    function saveStudent() {
      const activeTab = document.querySelector('.tab-content.active').id;
      
      if (activeTab === 'manual-tab') {
        saveManualStudent();
      } else {
        saveUploadedStudents();
      }
    }

    // Save manual student entry
    function saveManualStudent() {
      // Get form values
      const studentData = {
        name: document.getElementById('student-name').value.trim(),
        class: document.getElementById('student-class').value.trim(),
        gender: document.getElementById('student-gender').value
      };
      
      // Validate required fields
      if (!studentData.name) {
        showNotification('‚ùå Nama siswa harus diisi!', 'error');
        return;
      }
      
      if (!studentData.gender) {
        showNotification('‚ùå Jenis kelamin harus dipilih!', 'error');
        return;
      }
      
      if (!studentData.class) {
        showNotification('‚ùå Kelas belum terisi! Pastikan informasi sekolah sudah diisi.', 'error');
        return;
      }
      
      // Add student to table
      addStudentToTable(studentData);
      
      // Close modal and show success message
      closeAddStudentModal();
      showNotification('‚úÖ Data siswa berhasil ditambahkan!', 'success');
    }

    // Add student to the table
    function addStudentToTable(studentData) {
      // Add to persistent storage
      studentsList.push(studentData);
      savePersistedData();
      
      // Reload entire table to ensure correct numbering
      loadStudentsToTable();
    }
    
    function loadStudentsToTable() {
      const tableBody = document.getElementById('student-table-body');
      if (!tableBody) return;
      
      // Clear table
      tableBody.innerHTML = '';
      
      if (studentsList.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
              Belum ada data siswa. Klik "TAMBAH SISWA" untuk menambah siswa.
            </td>
          </tr>
        `;
        return;
      }
      
      // Add all students to table
      studentsList.forEach((student, index) => {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.name}</td>
          <td>${student.class}</td>
          <td>${student.gender}</td>
        `;
        tableBody.appendChild(newRow);
      });
    }

    // Handle file upload
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Show preview area
      document.getElementById('upload-preview').style.display = 'block';
      
      // Check file type
      const fileName = file.name.toLowerCase();
      const isCSV = fileName.endsWith('.csv');
      const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
      
      if (!isCSV && !isExcel) {
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = `
          <div style="color: rgba(239, 68, 68, 0.9); font-size: 14px; line-height: 1.6;">
            <strong>‚ùå Format file tidak didukung!</strong><br>
            Gunakan file CSV (.csv) untuk hasil terbaik<br>
            File Excel (.xlsx, .xls) mungkin tidak terbaca dengan benar
          </div>
        `;
        return;
      }
      
      // Preview file content for CSV files
      if (isCSV) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const students = parseCSVData(text);
            
            const previewContent = document.getElementById('preview-content');
            let previewHTML = `
              <div style="color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.6;">
                <strong>File:</strong> ${file.name}<br>
                <strong>Ukuran:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                <strong>Status:</strong> <span style="color: #22c55e;">‚úÖ File CSV siap diproses</span><br>
                <strong>Data ditemukan:</strong> ${students.length} siswa
              </div>
            `;
            
            if (students.length === 0) {
              previewHTML = `
                <div style="color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.6;">
                  <strong>File:</strong> ${file.name}<br>
                  <strong>Ukuran:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                  <strong>Status:</strong> <span style="color: rgba(239, 68, 68, 0.9);">‚ùå Tidak ada data siswa yang valid ditemukan!</span><br>
                  <strong>Data ditemukan:</strong> 0 siswa
                </div>
              `;
            }
            previewContent.innerHTML = previewHTML;
            
          } catch (error) {
            const previewContent = document.getElementById('preview-content');
            previewContent.innerHTML = `
              <div style="color: rgba(239, 68, 68, 0.9); font-size: 14px; line-height: 1.6;">
                <strong>‚ùå Error membaca file:</strong><br>
                ${error.message}
              </div>
            `;
          }
        };
        reader.readAsText(file);
      } else {
        // For Excel files, show warning
        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = `
          <div style="color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.6;">
            <strong>File:</strong> ${file.name}<br>
            <strong>Ukuran:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
            <strong>Status:</strong> <span style="color: #f59e0b;">‚ö†Ô∏è File Excel terdeteksi</span><br><br>
            <div style="background: rgba(245, 158, 11, 0.2); padding: 8px; border-radius: 4px; font-size: 12px;">
              <strong>‚ö†Ô∏è Peringatan:</strong><br>
              File Excel mungkin tidak terbaca dengan benar.<br>
              Untuk hasil terbaik, simpan file sebagai CSV terlebih dahulu.
            </div>
          </div>
        `;
      }
    }

    // Normalize gender input to L or P
    function normalizeGender(genderInput) {
      if (!genderInput) return '';
      
      const gender = genderInput.toString().toLowerCase().trim();
      
      // Check for male variations
      if (gender === 'l' || 
          gender === 'laki-laki' || 
          gender === 'laki laki' || 
          gender === 'lakilaki') {
        return 'L';
      }
      
      // Check for female variations  
      if (gender === 'p' || 
          gender === 'perempuan' || 
          gender === 'pr') {
        return 'P';
      }
      
      // Return original if no match (for validation)
      return genderInput.toString().toUpperCase();
    }

    // Save uploaded students
    function saveUploadedStudents() {
      const fileInput = document.getElementById('file-upload');
      if (!fileInput.files[0]) {
        showNotification('‚ùå Pilih file Excel terlebih dahulu!', 'error');
        return;
      }
      
      // Get current class from persistent storage
      const currentClass = schoolInfo.className;
      
      if (currentClass === '-' || !currentClass.trim()) {
        showNotification('‚ùå Isi informasi sekolah dan kelas terlebih dahulu!', 'error');
        return;
      }
      
      // Process the uploaded file
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const students = parseCSVData(text);
          
          if (students.length === 0) {
            showNotification('‚ùå Tidak ada data siswa yang valid ditemukan!', 'error');
            return;
          }
          
          // Add all students to table
          let successCount = 0;
          students.forEach(student => {
            if (student.name && student.gender) {
              const studentData = {
                name: student.name,
                class: currentClass,
                gender: normalizeGender(student.gender)
              };
              addStudentToTable(studentData);
              successCount++;
            }
          });
          
          closeAddStudentModal();
          showNotification(`‚úÖ Berhasil menambahkan ${successCount} siswa dari file!`, 'success');
          
        } catch (error) {
          showNotification('‚ùå Error membaca file: ' + error.message, 'error');
        }
      };
      
      reader.onerror = function() {
        showNotification('‚ùå Gagal membaca file!', 'error');
      };
      
      // Read file as text (works for CSV and simple Excel formats)
      reader.readAsText(file);
    }
    
    // Parse CSV data from uploaded file
    function parseCSVData(csvText) {
      const lines = csvText.split('\n');
      const students = [];
      
      // Skip header row (first line)
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // Split by comma, handle quoted values
        const columns = line.split(',').map(col => col.trim().replace(/^["']|["']$/g, ''));
        
        if (columns.length >= 2) {
          const name = columns[0];
          const gender = columns[1];
          
          if (name && gender) {
            students.push({
              name: name,
              gender: gender
            });
          }
        }
      }
      
      return students;
    }

    // Close modal when clicking outside
    document.getElementById('addStudentModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAddStudentModal();
      }
    });

    // Handle drag and drop for upload area
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        document.getElementById('file-upload').files = files;
        handleFileUpload({ target: { files: files } });
      }
    });

    // Show edit student form (placeholder function)
    function showEditStudentForm() {
      // Create a temporary notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 20px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 300px;
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 10px;">‚úèÔ∏è</div>
        <div>Form Edit Siswa</div>
        <div style="font-size: 14px; opacity: 0.8; margin-top: 8px;">Fitur akan segera tersedia</div>
      `;
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 3000);
    }

    // Edit mode functions
    let isEditMode = false;

    function toggleEditMode() {
      const displayMode = document.getElementById('display-mode');
      const editMode = document.getElementById('edit-mode');
      const editBtnText = document.getElementById('edit-btn-text');
      
      if (!isEditMode) {
        // Switch to edit mode
        displayMode.style.display = 'none';
        editMode.style.display = 'flex';
        editBtnText.textContent = 'BATAL';
        isEditMode = true;
        
        // Load current values into form from persistent storage
        document.getElementById('edit-school-name').value = schoolInfo.schoolName === '-' ? '' : schoolInfo.schoolName;
        document.getElementById('edit-class').value = schoolInfo.className === '-' ? '' : schoolInfo.className;
        document.getElementById('edit-teacher').value = schoolInfo.teacherName === '-' ? '' : schoolInfo.teacherName;
      } else {
        // Switch back to display mode
        cancelEdit();
      }
    }

    function saveSchoolInfo() {
      // Get values from form
      const schoolName = document.getElementById('edit-school-name').value.trim();
      const className = document.getElementById('edit-class').value.trim();
      const teacherName = document.getElementById('edit-teacher').value.trim();
      
      // Validate inputs
      if (!schoolName || !className || !teacherName) {
        showNotification('‚ùå Semua field harus diisi!', 'error');
        return;
      }
      
      // Save to persistent storage
      schoolInfo.schoolName = schoolName;
      schoolInfo.className = className;
      schoolInfo.teacherName = teacherName;
      savePersistedData();
      
      // Update display values
      document.getElementById('display-school-name').textContent = schoolName;
      document.getElementById('display-class').textContent = className;
      document.getElementById('display-teacher').textContent = teacherName;
      
      // Restart rotating subtitle with new data
      startRotatingSubtitle();
      
      // Switch back to display mode
      const displayMode = document.getElementById('display-mode');
      const editMode = document.getElementById('edit-mode');
      const editBtnText = document.getElementById('edit-btn-text');
      
      displayMode.style.display = 'flex';
      editMode.style.display = 'none';
      editBtnText.textContent = 'EDIT';
      isEditMode = false;
      
      // Show success notification
      showNotification('‚úÖ Informasi sekolah berhasil disimpan!', 'success');
    }
    
    function loadSchoolInfoToDisplay() {
      const displaySchoolName = document.getElementById('display-school-name');
      const displayClass = document.getElementById('display-class');
      const displayTeacher = document.getElementById('display-teacher');
      
      if (displaySchoolName) displaySchoolName.textContent = schoolInfo.schoolName;
      if (displayClass) displayClass.textContent = schoolInfo.className;
      if (displayTeacher) displayTeacher.textContent = schoolInfo.teacherName;
    }

    function cancelEdit() {
      const displayMode = document.getElementById('display-mode');
      const editMode = document.getElementById('edit-mode');
      const editBtnText = document.getElementById('edit-btn-text');
      
      displayMode.style.display = 'flex';
      editMode.style.display = 'none';
      editBtnText.textContent = 'EDIT';
      isEditMode = false;
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'rgba(34, 197, 94, 0.9)' : 
                     type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 
                     'rgba(0, 0, 0, 0.8)';
      
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${bgColor};
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 280px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 3000);
    }

    // Transaction functions
    let selectedTransactionType = '';

    function showNewTransactionModal() {
      const modal = document.getElementById('newTransactionModal');
      modal.classList.add('active');
      
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('new-transaction-date').value = today;
      
      // Reset form
      document.getElementById('new-transaction-form').reset();
      document.getElementById('new-transaction-date').value = today;
      document.getElementById('new-transaction-amount').value = '';
      
      // Reset transaction type buttons
      selectedTransactionType = '';
      document.getElementById('setor-btn').classList.remove('active-setor');
      document.getElementById('tarik-btn').classList.remove('active-tarik');
      
      // Load students into dropdown
      loadStudentsToDropdown();
    }

    function selectTransactionType(type) {
      selectedTransactionType = type;
      
      const setorBtn = document.getElementById('setor-btn');
      const tarikBtn = document.getElementById('tarik-btn');
      
      // Remove all active classes
      setorBtn.classList.remove('active-setor');
      tarikBtn.classList.remove('active-tarik');
      
      // Add active class to selected button
      if (type === 'setor') {
        setorBtn.classList.add('active-setor');
      } else if (type === 'tarik') {
        tarikBtn.classList.add('active-tarik');
      }
    }

    function formatRupiahInput(input) {
      // Remove all non-digit characters
      let value = input.value.replace(/[^\d]/g, '');
      
      // Format with thousand separators
      if (value) {
        value = parseInt(value).toLocaleString('id-ID');
        input.value = 'Rp ' + value;
      } else {
        input.value = '';
      }
    }

    function parseRupiahValue(rupiahString) {
      // Remove 'Rp' and dots, then parse to integer
      return parseInt(rupiahString.replace(/[^\d]/g, '')) || 0;
    }
    
    function closeNewTransactionModal() {
      const modal = document.getElementById('newTransactionModal');
      modal.classList.remove('active');
    }
    
    function loadStudentsToDropdown() {
      const dropdown = document.getElementById('new-transaction-student');
      
      // Clear existing options except the first one
      dropdown.innerHTML = '<option value="">-- Pilih Siswa --</option>';
      
      // Load students from persistent storage
      studentsList.forEach(student => {
        const option = document.createElement('option');
        option.value = student.name;
        option.textContent = student.name;
        dropdown.appendChild(option);
      });
    }
    

    
    function saveNewTransaction() {
      const date = document.getElementById('new-transaction-date').value;
      const studentName = document.getElementById('new-transaction-student').value;
      const amountInput = document.getElementById('new-transaction-amount').value;
      const amount = parseRupiahValue(amountInput);
      
      // Validate inputs
      if (!date) {
        showNotification('‚ùå Tanggal harus diisi!', 'error');
        return;
      }
      
      if (!studentName) {
        showNotification('‚ùå Pilih siswa terlebih dahulu!', 'error');
        return;
      }
      
      if (!selectedTransactionType) {
        showNotification('‚ùå Pilih jenis transaksi (SETOR atau TARIK)!', 'error');
        return;
      }
      
      if (amount <= 0) {
        showNotification('‚ùå Jumlah harus lebih dari 0!', 'error');
        return;
      }
      
      // Initialize student balance if not exists
      if (!studentBalances[studentName]) {
        studentBalances[studentName] = 0;
      }
      
      // Calculate new balance
      let setor = 0;
      let tarik = 0;
      
      if (selectedTransactionType === 'setor') {
        setor = amount;
        studentBalances[studentName] += amount;
      } else {
        tarik = amount;
        if (studentBalances[studentName] < amount) {
          showNotification('‚ùå Saldo tidak mencukupi untuk penarikan!', 'error');
          return;
        }
        studentBalances[studentName] -= amount;
      }
      
      // Create transaction object
      const transaction = {
        id: Date.now(),
        date: date,
        studentName: studentName,
        setor: setor,
        tarik: tarik,
        saldo: studentBalances[studentName]
      };
      
      // Add to transactions array
      allTransactions.push(transaction);
      
      // Save to persistent storage
      savePersistedData();
      
      // Refresh transaction table
      refreshTransactionTable();
      
      // Close modal and show success notification with details
      closeNewTransactionModal();
      showTransactionSuccessNotification(transaction);
      
      // Restart rotating saldo to update with new data
      if (currentPage === 'home') {
        startRotatingSaldo();
      } else {
        // Update top 5 even if not on home page
        updateTop5Students();
      }
    }
    
    function showTransactionSuccessNotification(transaction) {
      // Format date to Indonesian
      const dateObj = new Date(transaction.date);
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const formattedDate = `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
      
      // Determine background color based on transaction type
      let bgGradient = '';
      if (transaction.setor > 0 && transaction.tarik > 0) {
        // Both setor and tarik - orange
        bgGradient = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      } else if (transaction.setor > 0) {
        // Setor only - green
        bgGradient = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
      } else if (transaction.tarik > 0) {
        // Tarik only - red
        bgGradient = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      }
      
      // Create notification overlay
      const notifOverlay = document.createElement('div');
      notifOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
      `;
      
      // Create notification card
      const notifCard = document.createElement('div');
      notifCard.style.cssText = `
        background: ${bgGradient};
        border-radius: 12px;
        padding: 20px;
        max-width: 280px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        color: white;
        animation: slideUp 0.3s ease;
      `;
      
      notifCard.innerHTML = `
        <div style="text-align: center; margin-bottom: 12px;">
          <div style="font-size: 32px; margin-bottom: 6px;">‚úÖ</div>
          <div style="font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">SUKSES</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 14px; backdrop-filter: blur(10px);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-align: center; font-weight: 600;">
            ${formattedDate}
          </div>
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; text-align: center; letter-spacing: 0.3px;">
            ${transaction.studentName}
          </div>
          <div style="border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
              <span style="opacity: 0.9;">Setor:</span>
              <span style="font-weight: 700;">${transaction.setor > 0 ? formatCurrency(transaction.setor) : 'Rp 0'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
              <span style="opacity: 0.9;">Tarik:</span>
              <span style="font-weight: 700;">${transaction.tarik > 0 ? formatCurrency(transaction.tarik) : 'Rp 0'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 5px; border-top: 1px solid rgba(255, 255, 255, 0.2); font-size: 13px;">
              <span style="font-weight: 600;">Saldo:</span>
              <span style="font-weight: 800; font-size: 14px;">${formatCurrency(transaction.saldo)}</span>
            </div>
          </div>
        </div>
        
        <button id="notif-back-btn" style="
          width: 100%;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          padding: 10px;
          color: white;
          font-size: 13px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          backdrop-filter: blur(10px);
        ">
          KEMBALI
        </button>
      `;
      
      notifOverlay.appendChild(notifCard);
      document.body.appendChild(notifOverlay);
      
      // Add hover effect to button
      const backBtn = notifCard.querySelector('#notif-back-btn');
      backBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255, 255, 255, 0.3)';
        this.style.transform = 'translateY(-1px)';
      });
      backBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255, 255, 255, 0.2)';
        this.style.transform = 'translateY(0)';
      });
      
      // Handle back button click
      backBtn.addEventListener('click', function() {
        document.body.removeChild(notifOverlay);
        showNewTransactionModal();
      });
      
      // Close on overlay click
      notifOverlay.addEventListener('click', function(e) {
        if (e.target === notifOverlay) {
          document.body.removeChild(notifOverlay);
          showNewTransactionModal();
        }
      });
    }
    
    function refreshTransactionTable() {
      const tableBody = document.getElementById('transaction-table-body');
      if (!tableBody) return;
      
      // Get selected date filter
      const filterDate = document.getElementById('transaction-date-filter')?.value;
      
      // Filter transactions by date if filter is set
      let displayTransactions = allTransactions;
      if (filterDate) {
        displayTransactions = allTransactions.filter(t => t.date === filterDate);
      }
      
      // Clear table
      tableBody.innerHTML = '';
      
      if (displayTransactions.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
              ${filterDate ? 'Tidak ada transaksi pada tanggal ini.' : 'Belum ada transaksi. Klik "+ TRANSAKSI BARU" untuk menambah transaksi.'}
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort by date (newest first)
      displayTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Group transactions by student and date
      const groupedTransactions = {};
      displayTransactions.forEach(transaction => {
        const key = `${transaction.studentName}_${transaction.date}`;
        if (!groupedTransactions[key]) {
          groupedTransactions[key] = {
            studentName: transaction.studentName,
            date: transaction.date,
            setor: 0,
            tarik: 0,
            saldo: transaction.saldo,
            transactions: []
          };
        }
        groupedTransactions[key].setor += transaction.setor;
        groupedTransactions[key].tarik += transaction.tarik;
        groupedTransactions[key].transactions.push(transaction);
        // Use the latest saldo
        groupedTransactions[key].saldo = transaction.saldo;
      });
      
      // Convert to array and sort
      const groupedArray = Object.values(groupedTransactions);
      groupedArray.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Add rows with numbering
      groupedArray.forEach((group, index) => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td style="text-align: center; font-weight: 600;">${index + 1}</td>
          <td style="text-align: left; font-weight: 600;">${group.studentName}</td>
          <td style="text-align: right; font-weight: 700; color: ${group.setor > 0 ? '#22c55e' : 'rgba(255,255,255,0.5)'};">
            ${group.setor > 0 ? formatCurrency(group.setor) : '-'}
          </td>
          <td style="text-align: right; font-weight: 700; color: ${group.tarik > 0 ? '#ef4444' : 'rgba(255,255,255,0.5)'};">
            ${group.tarik > 0 ? formatCurrency(group.tarik) : '-'}
          </td>
          <td style="text-align: right; font-weight: 700;">
            ${formatCurrency(group.saldo)}
          </td>
          <td style="text-align: center;">
            <button onclick='showTransactionDetail(${JSON.stringify(group).replace(/'/g, "&apos;")})' style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 6px 10px; color: #ffffff; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease;">
              ‚úèÔ∏è
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    function showTransactionDetail(group) {
      // Format date to Indonesian
      const dateObj = new Date(group.date);
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const formattedDate = `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
      
      // Determine background color based on transaction type
      let bgGradient = '';
      if (group.setor > 0 && group.tarik > 0) {
        // Both setor and tarik - orange
        bgGradient = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      } else if (group.setor > 0) {
        // Setor only - green
        bgGradient = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
      } else if (group.tarik > 0) {
        // Tarik only - red
        bgGradient = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      }
      
      // Create notification overlay
      const notifOverlay = document.createElement('div');
      notifOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
      `;
      
      // Create notification card
      const notifCard = document.createElement('div');
      notifCard.style.cssText = `
        background: ${bgGradient};
        border-radius: 12px;
        padding: 20px;
        max-width: 280px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        color: white;
        animation: slideUp 0.3s ease;
      `;
      
      notifCard.innerHTML = `
        <div style="text-align: center; margin-bottom: 12px;">
          <div style="font-size: 32px; margin-bottom: 6px;">‚úÖ</div>
          <div style="font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">SUKSES</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 14px; backdrop-filter: blur(10px);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-align: center; font-weight: 600;">
            ${formattedDate}
          </div>
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; text-align: center; letter-spacing: 0.3px;">
            ${group.studentName}
          </div>
          <div style="border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
              <span style="opacity: 0.9;">Setor:</span>
              <span style="font-weight: 700;">${group.setor > 0 ? formatCurrency(group.setor) : 'Rp 0'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
              <span style="opacity: 0.9;">Tarik:</span>
              <span style="font-weight: 700;">${group.tarik > 0 ? formatCurrency(group.tarik) : 'Rp 0'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 5px; border-top: 1px solid rgba(255, 255, 255, 0.2); font-size: 13px;">
              <span style="font-weight: 600;">Saldo:</span>
              <span style="font-weight: 800; font-size: 14px;">${formatCurrency(group.saldo)}</span>
            </div>
          </div>
        </div>
        
        <button id="notif-close-btn" style="
          width: 100%;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          padding: 10px;
          color: white;
          font-size: 13px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          backdrop-filter: blur(10px);
        ">
          TUTUP
        </button>
      `;
      
      notifOverlay.appendChild(notifCard);
      document.body.appendChild(notifOverlay);
      
      // Add hover effect to button
      const closeBtn = notifCard.querySelector('#notif-close-btn');
      closeBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255, 255, 255, 0.3)';
        this.style.transform = 'translateY(-1px)';
      });
      closeBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255, 255, 255, 0.2)';
        this.style.transform = 'translateY(0)';
      });
      
      // Handle close button click
      closeBtn.addEventListener('click', function() {
        document.body.removeChild(notifOverlay);
      });
      
      // Close on overlay click
      notifOverlay.addEventListener('click', function(e) {
        if (e.target === notifOverlay) {
          document.body.removeChild(notifOverlay);
        }
      });
    }
    
    function formatCurrency(amount) {
      return 'Rp ' + amount.toLocaleString('id-ID');
    }
    
    function filterTransactionsByDate() {
      refreshTransactionTable();
    }
    
    // Close modal when clicking outside
    document.getElementById('newTransactionModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeNewTransactionModal();
      }
    });

    // Function to start rotating subtitle
    function startRotatingSubtitle() {
      // Clear existing interval if any
      if (subtitleInterval) {
        clearInterval(subtitleInterval);
      }
      
      // Get subtitle texts
      const subtitles = [
        'SELAMAT DATANG',
        schoolInfo.schoolName,
        schoolInfo.className,
        schoolInfo.teacherName
      ];
      
      // Set initial subtitle
      const subtitleEl = document.getElementById('app-subtitle');
      if (subtitleEl) {
        subtitleEl.textContent = subtitles[0];
        subtitleIndex = 0;
        
        // Rotate subtitle every 3 seconds
        subtitleInterval = setInterval(function() {
          subtitleIndex = (subtitleIndex + 1) % subtitles.length;
          subtitleEl.textContent = subtitles[subtitleIndex];
        }, 3000);
      }
    }
    
    // Function to calculate saldo statistics
    function calculateSaldoStatistics() {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Initialize counters
      let setorToday = 0;
      let tarikToday = 0;
      let setorMonth = 0;
      let tarikMonth = 0;
      let setorTotal = 0;
      let tarikTotal = 0;
      
      // Calculate from all transactions
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        // Today's transactions
        if (transaction.date === todayStr) {
          setorToday += transaction.setor;
          tarikToday += transaction.tarik;
        }
        
        // This month's transactions
        if (transMonth === currentMonth && transYear === currentYear) {
          setorMonth += transaction.setor;
          tarikMonth += transaction.tarik;
        }
        
        // Total transactions
        setorTotal += transaction.setor;
        tarikTotal += transaction.tarik;
      });
      
      // Calculate saldo amounts
      const saldoToday = setorToday - tarikToday;
      const saldoMonth = setorMonth - tarikMonth;
      const saldoTotal = setorTotal - tarikTotal;
      
      return {
        setorToday: setorToday,
        tarikToday: tarikToday,
        saldoToday: saldoToday,
        saldoMonth: saldoMonth,
        saldoTotal: saldoTotal
      };
    }
    
    // Function to start rotating saldo
    function startRotatingSaldo() {
      // Clear existing interval if any
      if (saldoInterval) {
        clearInterval(saldoInterval);
      }
      
      // Get saldo statistics
      const stats = calculateSaldoStatistics();
      
      // Define saldo data to rotate with corresponding labels and descriptions
      const saldoData = [
        {
          labelText: 'Saldo Hari Ini',
          labelKeterangan: 'Setor Hari Ini',
          value: formatCurrency(stats.saldoToday),
          descValue: formatCurrency(stats.setorToday)
        },
        {
          labelText: 'Saldo Bulan Ini',
          labelKeterangan: 'Tarik Hari Ini',
          value: formatCurrency(stats.saldoMonth),
          descValue: formatCurrency(stats.tarikToday)
        },
        {
          labelText: 'Saldo Akhir',
          labelKeterangan: 'Setor Hari Ini',
          value: formatCurrency(stats.saldoTotal),
          descValue: formatCurrency(stats.setorToday)
        }
      ];
      
      // Set initial saldo
      const balanceLabelEl = document.getElementById('balance-label');
      const balanceEl = document.getElementById('current-balance');
      const keteranganLabelEl = document.querySelector('.balance-column:last-child .info-label');
      const descriptionEl = document.getElementById('balance-description');
      
      if (balanceLabelEl && balanceEl && keteranganLabelEl && descriptionEl) {
        balanceLabelEl.textContent = saldoData[0].labelText;
        balanceEl.textContent = saldoData[0].value;
        keteranganLabelEl.textContent = saldoData[0].labelKeterangan;
        descriptionEl.textContent = saldoData[0].descValue;
        saldoIndex = 0;
        
        // Rotate saldo every 5 seconds
        saldoInterval = setInterval(function() {
          // Recalculate statistics to get latest data
          const latestStats = calculateSaldoStatistics();
          const latestSaldoData = [
            {
              labelText: 'Saldo Hari Ini',
              labelKeterangan: 'Setor Hari Ini',
              value: formatCurrency(latestStats.saldoToday),
              descValue: formatCurrency(latestStats.setorToday)
            },
            {
              labelText: 'Saldo Bulan Ini',
              labelKeterangan: 'Tarik Hari Ini',
              value: formatCurrency(latestStats.saldoMonth),
              descValue: formatCurrency(latestStats.tarikToday)
            },
            {
              labelText: 'Saldo Akhir',
              labelKeterangan: 'Setor Hari Ini',
              value: formatCurrency(latestStats.saldoTotal),
              descValue: formatCurrency(latestStats.setorToday)
            }
          ];
          
          saldoIndex = (saldoIndex + 1) % latestSaldoData.length;
          
          // Add fade effect
          balanceLabelEl.style.opacity = '0';
          balanceEl.style.opacity = '0';
          keteranganLabelEl.style.opacity = '0';
          descriptionEl.style.opacity = '0';
          
          setTimeout(() => {
            balanceLabelEl.textContent = latestSaldoData[saldoIndex].labelText;
            balanceEl.textContent = latestSaldoData[saldoIndex].value;
            keteranganLabelEl.textContent = latestSaldoData[saldoIndex].labelKeterangan;
            descriptionEl.textContent = latestSaldoData[saldoIndex].descValue;
            
            balanceLabelEl.style.opacity = '1';
            balanceEl.style.opacity = '1';
            keteranganLabelEl.style.opacity = '1';
            descriptionEl.style.opacity = '1';
          }, 150);
        }, 5000);
      }
      
      // Update top 5 students display
      updateTop5Students();
    }
    
    // Rotating top 5 students variables
    let top5Index = 0;
    let top5Interval = null;
    
    // Function to update top 5 students with highest balance (rotating display)
    function updateTop5Students() {
      const top5Container = document.getElementById('top-5-students');
      if (!top5Container) return;
      
      // Get all students with their balances
      const studentsWithBalance = studentsList.map(student => {
        return {
          name: student.name,
          balance: studentBalances[student.name] || 0
        };
      });
      
      // Sort by balance (highest first)
      studentsWithBalance.sort((a, b) => b.balance - a.balance);
      
      // Take top 5
      const top5 = studentsWithBalance.slice(0, 5);
      
      // Clear any existing interval
      if (top5Interval) {
        clearInterval(top5Interval);
        top5Interval = null;
      }
      
      // Clear container
      top5Container.innerHTML = '';
      
      if (top5.length === 0) {
        top5Container.innerHTML = `
          <div style="text-align: center; color: rgba(255, 255, 255, 0.6); padding: 20px; font-size: 13px; min-height: 80px; display: flex; align-items: center; justify-content: center;">
            Belum ada data siswa
          </div>
        `;
        return;
      }
      
      // Medal emojis for top 5
      const medals = ['‚ôõ', 'üú≤', '‚ôï', '‚ôö', '‚ôî'];
      
      // Function to display a single student
      function displayStudent(index) {
        if (index >= top5.length) return;
        
        const student = top5[index];
        
        // Add fade effect
        top5Container.style.opacity = '0';
        top5Container.style.transition = 'opacity 0.3s ease';
        
        setTimeout(() => {
          top5Container.innerHTML = '';
          
          const studentItem = document.createElement('div');
          studentItem.style.cssText = `
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 16px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            min-height: 80px;
            height: 80px;
          `;
          
          studentItem.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
              <div style="font-size: 28px; animation: bounceIn 0.5s ease; min-width: 35px; width: 35px; text-align: center; flex-shrink: 0;">${medals[index]}</div>
              <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;">
                <div style="color: #ffffff; font-size: 13px; font-weight: 800; margin-bottom: 3px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  ${index + 1}. ${student.name}
                </div>
                <div style="color: #ffffff; font-size: 15px; font-weight: 900; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">
                  ${formatCurrency(student.balance)}
                </div>
              </div>
            </div>
          `;
          
          top5Container.appendChild(studentItem);
          top5Container.style.opacity = '1';
        }, 300);
      }
      
      // Display first student immediately
      top5Index = 0;
      displayStudent(top5Index);
      
      // Rotate through students every 3 seconds
      top5Interval = setInterval(() => {
        top5Index = (top5Index + 1) % top5.length;
        displayStudent(top5Index);
      }, 3000);
    }

    // Initialize the date display when page loads and update every minute
    document.addEventListener('DOMContentLoaded', function() {
      // Load persisted data from localStorage
      loadPersistedData();
      
      // Load color preference
      loadColorPreference();
      
      document.getElementById('current-date').textContent = getCurrentDateTime();
      
      // Start rotating subtitle
      startRotatingSubtitle();
      
      // Start rotating saldo
      startRotatingSaldo();
      
      // Update time every minute
      setInterval(function() {
        document.getElementById('current-date').textContent = getCurrentDateTime();
      }, 60000);
    });
    
    // Set today's date when navigating to transaction page
    function setTodayDateFilter() {
      const today = new Date().toISOString().split('T')[0];
      const dateFilter = document.getElementById('transaction-date-filter');
      if (dateFilter) {
        dateFilter.value = today;
        filterTransactionsByDate();
      }
    }
    
    // Switch between laporan tabs
    function switchLaporanTab(tabName) {
      // Remove active class from all tabs and buttons
      document.querySelectorAll('#riwayat-tab, #rekap-tab').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      
      // Add active class to selected tab and button
      document.getElementById(`${tabName}-tab`).classList.add('active');
      event.target.classList.add('active');
      
      // Load data for the selected tab
      if (tabName === 'riwayat') {
        loadRiwayatData();
      } else if (tabName === 'rekap') {
        loadRekapData();
      }
    }
    
    // Format number to ribuan format (e.g., 20000 -> 20RB, 1500 -> 1.5RB)
    function formatToRibuan(amount) {
      if (amount === 0) return '0';
      
      if (amount >= 1000) {
        const ribuan = amount / 1000;
        // If it's a whole number, show without decimals
        if (ribuan % 1 === 0) {
          return ribuan + 'RB';
        } else {
          // Show one decimal place
          return ribuan.toFixed(1) + 'RB';
        }
      } else {
        // Less than 1000, show as is
        return amount.toString();
      }
    }
    
    // Shorten student names intelligently
    function shortenStudentName(studentName, allStudentNames) {
      const names = allStudentNames.map(name => name.trim());
      const currentName = studentName.trim();
      const nameParts = currentName.split(' ');
      
      // If only one word, return as is
      if (nameParts.length === 1) {
        return currentName;
      }
      
      // Get first name
      const firstName = nameParts[0];
      
      // Check if there are other students with the same first name
      const sameFirstName = names.filter(name => {
        const parts = name.split(' ');
        return parts[0] === firstName && name !== currentName;
      });
      
      // If no conflict, return first name only
      if (sameFirstName.length === 0) {
        return firstName;
      }
      
      // If conflict exists, abbreviate first name and add second name
      if (nameParts.length >= 2) {
        const firstInitial = firstName.charAt(0).toUpperCase() + '.';
        const secondName = nameParts[1];
        return `${firstInitial} ${secondName}`;
      }
      
      return currentName;
    }
    
    // Populate year filter with years 2025-2030
    function populateYearFilter() {
      const yearFilter = document.getElementById('riwayat-year-filter');
      if (!yearFilter) return;
      
      // Clear and populate with years 2025-2030
      yearFilter.innerHTML = '';
      for (let year = 2025; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      }
    }
    
    // Load riwayat data with new format
    function loadRiwayatData() {
      // Populate year filter
      populateYearFilter();
      
      // Set current month and year as default
      const today = new Date();
      const monthFilter = document.getElementById('riwayat-month-filter');
      const yearFilter = document.getElementById('riwayat-year-filter');
      
      if (monthFilter && !monthFilter.value) {
        monthFilter.value = today.getMonth().toString();
      }
      if (yearFilter && !yearFilter.value) {
        yearFilter.value = today.getFullYear().toString();
      }
      
      // Load the table
      filterRiwayatByMonthYear();
    }
    
    // Filter riwayat by month and year
    function filterRiwayatByMonthYear() {
      const monthFilter = document.getElementById('riwayat-month-filter');
      const yearFilter = document.getElementById('riwayat-year-filter');
      const tableHead = document.querySelector('#riwayat-table thead tr');
      const tableBody = document.getElementById('riwayat-table-body');
      
      if (!monthFilter || !yearFilter || !tableHead || !tableBody) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      // If no month or year selected, show message
      if (selectedMonth === '' || selectedYear === '') {
        tableBody.innerHTML = `
          <tr>
            <td colspan="32" style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
              Pilih bulan dan tahun untuk melihat riwayat transaksi.
            </td>
          </tr>
        `;
        return;
      }
      
      const month = parseInt(selectedMonth);
      const year = parseInt(selectedYear);
      
      // Get number of days in selected month
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // Generate table header with dates
      tableHead.innerHTML = '<th style="width: 120px; min-width: 100px; position: sticky; left: 0; background: #ffffff; z-index: 10; color: #000000; border: 1px solid #000000;">NAMA</th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const th = document.createElement('th');
        th.style.cssText = 'width: 45px; min-width: 45px; max-width: 45px; text-align: center; font-size: 11px; padding: 8px 4px; background: #ffffff; color: #000000; border: 1px solid #000000;';
        th.textContent = day;
        tableHead.appendChild(th);
      }
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      if (allStudentNames.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="${daysInMonth + 1}" style="text-align: center; color: #666666; padding: 40px; background: #ffffff;">
              Belum ada data siswa.
            </td>
          </tr>
        `;
        return;
      }
      
      // Create transaction map: studentName -> date -> transactions (array for multiple transactions per day)
      const transactionMap = {};
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        const transDay = transDate.getDate();
        
        if (transMonth === month && transYear === year) {
          if (!transactionMap[transaction.studentName]) {
            transactionMap[transaction.studentName] = {};
          }
          if (!transactionMap[transaction.studentName][transDay]) {
            transactionMap[transaction.studentName][transDay] = [];
          }
          transactionMap[transaction.studentName][transDay].push(transaction);
        }
      });
      
      // Clear table body
      tableBody.innerHTML = '';
      
      // Generate rows for each student
      allStudentNames.forEach(studentName => {
        const row = document.createElement('tr');
        
        // Name column (sticky)
        const nameCell = document.createElement('td');
        nameCell.style.cssText = 'position: sticky; left: 0; background: #ffffff; z-index: 5; font-weight: 700; text-align: left; padding: 10px 8px; font-size: 12px; border: 1px solid #000000; color: #000000;';
        nameCell.textContent = shortenStudentName(studentName, allStudentNames);
        row.appendChild(nameCell);
        
        // Date columns
        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement('td');
          cell.style.cssText = 'text-align: center; padding: 6px 4px; background: #ffffff; border: 1px solid #000000; width: 45px; min-width: 45px; max-width: 45px;';
          
          const transactions = transactionMap[studentName]?.[day];
          
          if (transactions && transactions.length > 0) {
            // Calculate totals for the day
            let totalSetor = 0;
            let totalTarik = 0;
            let finalSaldo = 0;
            
            transactions.forEach(trans => {
              totalSetor += trans.setor;
              totalTarik += trans.tarik;
              finalSaldo = trans.saldo; // Use the last saldo
            });
            
            // Create button with appropriate symbol and color
            const button = document.createElement('button');
            button.style.cssText = 'border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 14px; font-weight: 800; transition: all 0.3s ease; width: 38px; height: 32px; display: flex; align-items: center; justify-content: center;';
            
            let displayText = '';
            let bgColor = '';
            
            if (totalSetor > 0 && totalTarik > 0) {
              // Both setor and tarik - show net amount in orange
              const netAmount = totalSetor - totalTarik;
              displayText = formatToRibuan(Math.abs(netAmount));
              bgColor = '#f59e0b';
            } else if (totalSetor > 0) {
              // Setor only - green
              displayText = formatToRibuan(totalSetor);
              bgColor = '#22c55e';
            } else if (totalTarik > 0) {
              // Tarik only - red
              displayText = formatToRibuan(totalTarik);
              bgColor = '#ef4444';
            }
            
            button.style.background = bgColor;
            button.style.color = '#ffffff';
            button.textContent = displayText;
            
            // Add hover effect
            button.addEventListener('mouseenter', function() {
              this.style.transform = 'scale(1.1)';
              this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            });
            button.addEventListener('mouseleave', function() {
              this.style.transform = 'scale(1)';
              this.style.boxShadow = 'none';
            });
            
            // Add click handler to show detail
            button.addEventListener('click', function() {
              showRiwayatTransactionDetail({
                studentName: studentName,
                date: `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
                setor: totalSetor,
                tarik: totalTarik,
                saldo: finalSaldo
              });
            });
            
            cell.appendChild(button);
          } else {
            cell.textContent = '-';
            cell.style.color = '#cccccc';
            cell.style.fontSize = '13px';
            cell.style.fontWeight = '600';
          }
          
          row.appendChild(cell);
        }
        
        tableBody.appendChild(row);
      });
    }
    
    // Show riwayat transaction detail notification
    function showRiwayatTransactionDetail(data) {
      // Format date to Indonesian
      const dateObj = new Date(data.date);
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const formattedDate = `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
      
      // Determine background color based on transaction type
      let bgGradient = '';
      if (data.setor > 0 && data.tarik > 0) {
        // Both setor and tarik - orange
        bgGradient = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      } else if (data.setor > 0) {
        // Setor only - green
        bgGradient = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
      } else if (data.tarik > 0) {
        // Tarik only - red
        bgGradient = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      }
      
      // Create notification overlay
      const notifOverlay = document.createElement('div');
      notifOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
      `;
      
      // Create notification card
      const notifCard = document.createElement('div');
      notifCard.style.cssText = `
        background: ${bgGradient};
        border-radius: 12px;
        padding: 20px;
        max-width: 280px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        color: white;
        animation: slideUp 0.3s ease;
      `;
      
      notifCard.innerHTML = `
        <div style="text-align: center; margin-bottom: 12px;">
          <div style="font-size: 32px; margin-bottom: 6px;">‚úÖ</div>
          <div style="font-size: 15px; font-weight: 700; letter-spacing: 0.5px;">SUKSES</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 14px; backdrop-filter: blur(10px);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-align: center; font-weight: 600;">
            ${formattedDate}
          </div>
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; text-align: center; letter-spacing: 0.3px;">
            ${data.studentName}
          </div>
          <div style="border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
              <span style="opacity: 0.9;">Setor:</span>
              <span style="font-weight: 700;">${data.setor > 0 ? formatCurrency(data.setor) : 'Rp 0'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
              <span style="opacity: 0.9;">Tarik:</span>
              <span style="font-weight: 700;">${data.tarik > 0 ? formatCurrency(data.tarik) : 'Rp 0'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 5px; border-top: 1px solid rgba(255, 255, 255, 0.2); font-size: 13px;">
              <span style="font-weight: 600;">Saldo:</span>
              <span style="font-weight: 800; font-size: 14px;">${formatCurrency(data.saldo)}</span>
            </div>
          </div>
        </div>
        
        <button id="notif-close-btn" style="
          width: 100%;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          padding: 10px;
          color: white;
          font-size: 13px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          backdrop-filter: blur(10px);
        ">
          TUTUP
        </button>
      `;
      
      notifOverlay.appendChild(notifCard);
      document.body.appendChild(notifOverlay);
      
      // Add hover effect to button
      const closeBtn = notifCard.querySelector('#notif-close-btn');
      closeBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255, 255, 255, 0.3)';
        this.style.transform = 'translateY(-1px)';
      });
      closeBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255, 255, 255, 0.2)';
        this.style.transform = 'translateY(0)';
      });
      
      // Handle close button click
      closeBtn.addEventListener('click', function() {
        document.body.removeChild(notifOverlay);
      });
      
      // Close on overlay click
      notifOverlay.addEventListener('click', function(e) {
        if (e.target === notifOverlay) {
          document.body.removeChild(notifOverlay);
        }
      });
    }
    
    // Load rekap data
    function loadRekapData() {
      // Populate year filter
      const yearFilter = document.getElementById('rekap-year-filter');
      if (yearFilter) {
        yearFilter.innerHTML = '';
        for (let year = 2025; year <= 2030; year++) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearFilter.appendChild(option);
        }
      }
      
      // Set current month and year as default
      const today = new Date();
      const monthFilter = document.getElementById('rekap-month-filter');
      
      if (monthFilter && !monthFilter.value) {
        monthFilter.value = today.getMonth().toString();
      }
      if (yearFilter && !yearFilter.value) {
        yearFilter.value = today.getFullYear().toString();
      }
      
      // Load the table
      filterRekapByMonthYear();
    }
    
    // Filter rekap by month and year
    function filterRekapByMonthYear() {
      const monthFilter = document.getElementById('rekap-month-filter');
      const yearFilter = document.getElementById('rekap-year-filter');
      const tableBody = document.getElementById('rekap-table-body');
      
      if (!monthFilter || !yearFilter || !tableBody) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      // If no month or year selected, show message
      if (selectedMonth === '' || selectedYear === '') {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: #666666; padding: 40px; background: #ffffff;">
              Pilih bulan dan tahun untuk melihat rekap transaksi.
            </td>
          </tr>
        `;
        return;
      }
      
      const month = parseInt(selectedMonth);
      const year = parseInt(selectedYear);
      
      // Clear table
      tableBody.innerHTML = '';
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      if (allStudentNames.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: #666666; padding: 40px; background: #ffffff;">
              Belum ada data siswa.
            </td>
          </tr>
        `;
        return;
      }
      
      // Calculate totals per student for selected month
      const studentMonthTotals = {};
      
      // Sort transactions by date to get the last transaction of the month
      const sortedTransactions = [...allTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      sortedTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        // Initialize student if not exists
        if (!studentMonthTotals[transaction.studentName]) {
          studentMonthTotals[transaction.studentName] = {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
        }
        
        // Only count transactions from selected month
        if (transMonth === month && transYear === year) {
          studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
          studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
          // Use the last transaction's saldo as saldo bulan ini (will be overwritten by later transactions)
          studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
        }
      });
      
      // Add rows for each student
      allStudentNames.forEach(studentName => {
        const monthData = studentMonthTotals[studentName] || {
          totalSetor: 0,
          totalTarik: 0,
          saldoBulanIni: 0
        };
        
        const saldoAkhir = studentBalances[studentName] || 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="text-align: left; background: #ffffff; color: #000000; border: 1px solid #000000; font-weight: 600;">${studentName}</td>
          <td style="text-align: right; color: #22c55e; font-weight: 700; background: #ffffff; border: 1px solid #000000;">
            ${monthData.totalSetor > 0 ? formatCurrency(monthData.totalSetor) : 'Rp 0'}
          </td>
          <td style="text-align: right; color: #ef4444; font-weight: 700; background: #ffffff; border: 1px solid #000000;">
            ${monthData.totalTarik > 0 ? formatCurrency(monthData.totalTarik) : 'Rp 0'}
          </td>
          <td style="text-align: right; font-weight: 700; background: #ffffff; color: #000000; border: 1px solid #000000;">
            ${formatCurrency(monthData.saldoBulanIni)}
          </td>
          <td style="text-align: right; font-weight: 700; background: #ffffff; color: #000000; border: 1px solid #000000;">
            ${formatCurrency(saldoAkhir)}
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      // If no students have data, show message
      if (allStudentNames.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: #666666; padding: 40px; background: #ffffff;">
              Belum ada data rekap untuk bulan ini.
            </td>
          </tr>
        `;
      }
    }
    
    // Unduh functions
    function unduhRiwayatPDF() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      if (selectedMonth === '' || selectedYear === '') {
        showNotification('‚ùå Pilih bulan dan tahun terlebih dahulu!', 'error');
        return;
      }
      
      // Check if "SEMUA DATA" is selected
      if (selectedMonth === 'all' && selectedYear === 'all') {
        generateAllDataRiwayatPDF();
      } else {
        generateRiwayatPDF(parseInt(selectedMonth), parseInt(selectedYear));
      }
    }
    
    function unduhRekapPDF() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      if (selectedMonth === '' || selectedYear === '') {
        showNotification('‚ùå Pilih bulan dan tahun terlebih dahulu!', 'error');
        return;
      }
      
      // Check if "SEMUA DATA" is selected
      if (selectedMonth === 'all' && selectedYear === 'all') {
        generateAllDataRekapPDF();
      } else {
        generateRekapPDF(parseInt(selectedMonth), parseInt(selectedYear));
      }
    }
    
    function unduhRiwayatXLSX() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      if (selectedMonth === '' || selectedYear === '') {
        showNotification('‚ùå Pilih bulan dan tahun terlebih dahulu!', 'error');
        return;
      }
      
      if (selectedMonth === 'all' && selectedYear === 'all') {
        generateAllDataRiwayatXLSX();
      } else {
        generateRiwayatXLSX(parseInt(selectedMonth), parseInt(selectedYear));
      }
    }
    
    function unduhRiwayatCSV() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      if (selectedMonth === '' || selectedYear === '') {
        showNotification('‚ùå Pilih bulan dan tahun terlebih dahulu!', 'error');
        return;
      }
      
      if (selectedMonth === 'all' && selectedYear === 'all') {
        generateAllDataRiwayatCSV();
      } else {
        generateRiwayatCSV(parseInt(selectedMonth), parseInt(selectedYear));
      }
    }
    
    function unduhRekapXLSX() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      if (selectedMonth === '' || selectedYear === '') {
        showNotification('‚ùå Pilih bulan dan tahun terlebih dahulu!', 'error');
        return;
      }
      
      if (selectedMonth === 'all' && selectedYear === 'all') {
        generateAllDataRekapXLSX();
      } else {
        generateRekapXLSX(parseInt(selectedMonth), parseInt(selectedYear));
      }
    }
    
    function unduhRekapCSV() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      if (selectedMonth === '' || selectedYear === '') {
        showNotification('‚ùå Pilih bulan dan tahun terlebih dahulu!', 'error');
        return;
      }
      
      if (selectedMonth === 'all' && selectedYear === 'all') {
        generateAllDataRekapCSV();
      } else {
        generateRekapCSV(parseInt(selectedMonth), parseInt(selectedYear));
      }
    }
    
    function generateRiwayatPDF(month, year) {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      const monthName = months[month];
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      // Create transaction map
      const transactionMap = {};
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        const transDay = transDate.getDate();
        
        if (transMonth === month && transYear === year) {
          if (!transactionMap[transaction.studentName]) {
            transactionMap[transaction.studentName] = {};
          }
          if (!transactionMap[transaction.studentName][transDay]) {
            transactionMap[transaction.studentName][transDay] = [];
          }
          transactionMap[transaction.studentName][transDay].push(transaction);
        }
      });
      
      // Create PDF using jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Add title
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('RIWAYAT TRANSAKSI', 148, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text(`BULAN ${monthName} ${year}`, 148, 22, { align: 'center' });
      
      // Add school info
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Sekolah: ${schoolInfo.schoolName}`, 14, 32);
      doc.text(`Kelas: ${schoolInfo.className}`, 14, 37);
      doc.text(`Wali Kelas: ${schoolInfo.teacherName}`, 14, 42);
      
      // Prepare table data
      const tableHeaders = ['NO', 'NAMA'];
      for (let day = 1; day <= daysInMonth; day++) {
        tableHeaders.push(day.toString());
      }
      tableHeaders.push('SETOR', 'TARIK', 'SALDO\nBULAN', 'SALDO\nAKHIR');
      
      const tableData = [];
      allStudentNames.forEach((studentName, index) => {
        let totalSetorBulan = 0;
        let totalTarikBulan = 0;
        
        const row = [index + 1, studentName];
        
        // Add date columns
        for (let day = 1; day <= daysInMonth; day++) {
          const transactions = transactionMap[studentName]?.[day];
          
          if (transactions && transactions.length > 0) {
            let totalSetor = 0;
            let totalTarik = 0;
            
            transactions.forEach(trans => {
              totalSetor += trans.setor;
              totalTarik += trans.tarik;
              totalSetorBulan += trans.setor;
              totalTarikBulan += trans.tarik;
            });
            
            let displayText = '';
            if (totalSetor > 0 && totalTarik > 0) {
              const netAmount = totalSetor - totalTarik;
              if (netAmount > 0) {
                displayText = '+' + formatToRibuan(netAmount);
              } else if (netAmount < 0) {
                displayText = '-' + formatToRibuan(Math.abs(netAmount));
              } else {
                displayText = '0';
              }
            } else if (totalSetor > 0) {
              displayText = '+' + formatToRibuan(totalSetor);
            } else if (totalTarik > 0) {
              displayText = '-' + formatToRibuan(totalTarik);
            }
            
            row.push(displayText);
          } else {
            row.push('-');
          }
        }
        
        const saldoBulan = totalSetorBulan - totalTarikBulan;
        const saldoAkhir = studentBalances[studentName] || 0;
        
        row.push(totalSetorBulan, totalTarikBulan, saldoBulan, saldoAkhir);
        tableData.push(row);
      });
      
      // Add table
      doc.autoTable({
        head: [tableHeaders],
        body: tableData,
        startY: 48,
        styles: { 
          fontSize: 7,
          cellPadding: 1.5,
          halign: 'center',
          valign: 'middle'
        },
        headStyles: {
          fillColor: [64, 224, 208],
          textColor: [255, 255, 255],
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 8, halign: 'center' },
          1: { cellWidth: 30, halign: 'left' }
        },
        margin: { left: 14, right: 14 }
      });
      
      // Save PDF
      doc.save(`Riwayat_${monthName}_${year}.pdf`);
      showNotification('‚úÖ File PDF berhasil diunduh!', 'success');
    }
    
    function generateRekapPDF(month, year) {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      const monthName = months[month];
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      // Calculate totals per student
      const studentMonthTotals = {};
      
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        if (!studentMonthTotals[transaction.studentName]) {
          studentMonthTotals[transaction.studentName] = {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
        }
        
        if (transMonth === month && transYear === year) {
          studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
          studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
          // Use the last transaction's saldo as saldo bulan ini
          studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
        }
      });
      
      // Create PDF using jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('portrait', 'mm', 'a4');
      
      // Add title
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('REKAP TRANSAKSI', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text(`BULAN ${monthName} ${year}`, 105, 22, { align: 'center' });
      
      // Add school info
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Sekolah: ${schoolInfo.schoolName}`, 14, 32);
      doc.text(`Kelas: ${schoolInfo.className}`, 14, 37);
      doc.text(`Wali Kelas: ${schoolInfo.teacherName}`, 14, 42);
      
      // Prepare table data
      const tableHeaders = ['NO', 'NAMA SISWA', 'TOTAL SETOR', 'TOTAL TARIK', 'SALDO\nBULAN INI', 'SALDO\nAKHIR'];
      const tableData = [];
      
      allStudentNames.forEach((studentName, index) => {
        const monthData = studentMonthTotals[studentName] || {
          totalSetor: 0,
          totalTarik: 0,
          saldoBulanIni: 0
        };
        
        const saldoAkhir = studentBalances[studentName] || 0;
        
        tableData.push([
          index + 1,
          studentName,
          formatCurrency(monthData.totalSetor),
          formatCurrency(monthData.totalTarik),
          formatCurrency(monthData.saldoBulanIni),
          formatCurrency(saldoAkhir)
        ]);
      });
      
      // Add table
      doc.autoTable({
        head: [tableHeaders],
        body: tableData,
        startY: 48,
        styles: { 
          fontSize: 9,
          cellPadding: 3,
          halign: 'center',
          valign: 'middle'
        },
        headStyles: {
          fillColor: [64, 224, 208],
          textColor: [255, 255, 255],
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 12, halign: 'center' },
          1: { cellWidth: 50, halign: 'left' },
          2: { cellWidth: 30, halign: 'right' },
          3: { cellWidth: 30, halign: 'right' },
          4: { cellWidth: 30, halign: 'right' },
          5: { cellWidth: 30, halign: 'right' }
        },
        margin: { left: 14, right: 14 }
      });
      
      // Save PDF
      doc.save(`Rekap_${monthName}_${year}.pdf`);
      showNotification('‚úÖ File PDF berhasil diunduh!', 'success');
    }
    
    // Generate PDF for all data (all months and years)
    function generateAllDataRiwayatPDF() {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      
      // Get all unique month-year combinations from transactions
      const monthYearSet = new Set();
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const key = `${transDate.getFullYear()}-${transDate.getMonth()}`;
        monthYearSet.add(key);
      });
      
      // Convert to array and sort
      const monthYearArray = Array.from(monthYearSet).map(key => {
        const [year, month] = key.split('-');
        return { year: parseInt(year), month: parseInt(month) };
      }).sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
      
      if (monthYearArray.length === 0) {
        showNotification('‚ùå Tidak ada data transaksi!', 'error');
        return;
      }
      
      // Create PDF using jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Add title on first page
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('RIWAYAT TRANSAKSI', 148, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text('SEMUA DATA', 148, 22, { align: 'center' });
      
      // Add school info
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Sekolah: ${schoolInfo.schoolName}`, 14, 32);
      doc.text(`Kelas: ${schoolInfo.className}`, 14, 37);
      doc.text(`Wali Kelas: ${schoolInfo.teacherName}`, 14, 42);
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      let startY = 48;
      
      // Generate table for each month
      monthYearArray.forEach((monthYear, monthIndex) => {
        const month = monthYear.month;
        const year = monthYear.year;
        const monthName = months[month];
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Add new page for each month (except first)
        if (monthIndex > 0) {
          doc.addPage();
          startY = 15;
        }
        
        // Month title
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`BULAN: ${monthName} ${year}`, 14, startY);
        startY += 7;
        
        // Prepare table data
        const tableHeaders = ['NO', 'NAMA'];
        for (let day = 1; day <= daysInMonth; day++) {
          tableHeaders.push(day.toString());
        }
        tableHeaders.push('SETOR', 'TARIK', 'SALDO\nBULAN', 'SALDO\nAKHIR');
        
        // Create transaction map for this month
        const transactionMap = {};
        allTransactions.forEach(transaction => {
          const transDate = new Date(transaction.date);
          const transMonth = transDate.getMonth();
          const transYear = transDate.getFullYear();
          const transDay = transDate.getDate();
          
          if (transMonth === month && transYear === year) {
            if (!transactionMap[transaction.studentName]) {
              transactionMap[transaction.studentName] = {};
            }
            if (!transactionMap[transaction.studentName][transDay]) {
              transactionMap[transaction.studentName][transDay] = [];
            }
            transactionMap[transaction.studentName][transDay].push(transaction);
          }
        });
        
        const tableData = [];
        allStudentNames.forEach((studentName, index) => {
          let totalSetorBulan = 0;
          let totalTarikBulan = 0;
          
          const row = [index + 1, studentName];
          
          // Add date columns
          for (let day = 1; day <= daysInMonth; day++) {
            const transactions = transactionMap[studentName]?.[day];
            
            if (transactions && transactions.length > 0) {
              let totalSetor = 0;
              let totalTarik = 0;
              
              transactions.forEach(trans => {
                totalSetor += trans.setor;
                totalTarik += trans.tarik;
                totalSetorBulan += trans.setor;
                totalTarikBulan += trans.tarik;
              });
              
              let displayText = '';
              if (totalSetor > 0 && totalTarik > 0) {
                const netAmount = totalSetor - totalTarik;
                displayText = formatToRibuan(Math.abs(netAmount));
              } else if (totalSetor > 0) {
                displayText = formatToRibuan(totalSetor);
              } else if (totalTarik > 0) {
                displayText = formatToRibuan(totalTarik);
              }
              
              row.push(displayText);
            } else {
              row.push('-');
            }
          }
          
          const saldoBulan = totalSetorBulan - totalTarikBulan;
          const saldoAkhir = studentBalances[studentName] || 0;
          
          row.push(totalSetorBulan, totalTarikBulan, saldoBulan, saldoAkhir);
          tableData.push(row);
        });
        
        // Add table
        doc.autoTable({
          head: [tableHeaders],
          body: tableData,
          startY: startY,
          styles: { 
            fontSize: 7,
            cellPadding: 1.5,
            halign: 'center',
            valign: 'middle'
          },
          headStyles: {
            fillColor: [64, 224, 208],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center'
          },
          columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            1: { cellWidth: 30, halign: 'left' }
          },
          margin: { left: 14, right: 14 }
        });
      });
      
      // Save PDF
      doc.save('Riwayat_Semua_Data.pdf');
      showNotification('‚úÖ File PDF berhasil diunduh!', 'success');
    }
    
    // Generate PDF for all data rekap (all months and years)
    function generateAllDataRekapPDF() {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      
      // Get all unique month-year combinations from transactions
      const monthYearSet = new Set();
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const key = `${transDate.getFullYear()}-${transDate.getMonth()}`;
        monthYearSet.add(key);
      });
      
      // Convert to array and sort
      const monthYearArray = Array.from(monthYearSet).map(key => {
        const [year, month] = key.split('-');
        return { year: parseInt(year), month: parseInt(month) };
      }).sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
      
      if (monthYearArray.length === 0) {
        showNotification('‚ùå Tidak ada data transaksi!', 'error');
        return;
      }
      
      // Create PDF using jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('portrait', 'mm', 'a4');
      
      // Add title on first page
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('REKAP TRANSAKSI', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text('SEMUA DATA', 105, 22, { align: 'center' });
      
      // Add school info
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Sekolah: ${schoolInfo.schoolName}`, 14, 32);
      doc.text(`Kelas: ${schoolInfo.className}`, 14, 37);
      doc.text(`Wali Kelas: ${schoolInfo.teacherName}`, 14, 42);
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      let startY = 48;
      
      // Generate table for each month
      monthYearArray.forEach((monthYear, monthIndex) => {
        const month = monthYear.month;
        const year = monthYear.year;
        const monthName = months[month];
        
        // Add new page for each month (except first)
        if (monthIndex > 0) {
          doc.addPage();
          startY = 15;
        }
        
        // Month title
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`BULAN: ${monthName} ${year}`, 14, startY);
        startY += 7;
        
        // Calculate totals per student for this month
        const studentMonthTotals = {};
        
        allTransactions.forEach(transaction => {
          const transDate = new Date(transaction.date);
          const transMonth = transDate.getMonth();
          const transYear = transDate.getFullYear();
          
          if (!studentMonthTotals[transaction.studentName]) {
            studentMonthTotals[transaction.studentName] = {
              totalSetor: 0,
              totalTarik: 0,
              saldoBulanIni: 0
            };
          }
          
          if (transMonth === month && transYear === year) {
            studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
            studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
            // Use the last transaction's saldo as saldo bulan ini
            studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
          }
        });
        
        // Prepare table data
        const tableHeaders = ['NO', 'NAMA SISWA', 'TOTAL SETOR', 'TOTAL TARIK', 'SALDO\nBULAN INI', 'SALDO\nAKHIR'];
        const tableData = [];
        
        allStudentNames.forEach((studentName, index) => {
          const monthData = studentMonthTotals[studentName] || {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
          
          const saldoAkhir = studentBalances[studentName] || 0;
          
          tableData.push([
            index + 1,
            studentName,
            formatCurrency(monthData.totalSetor),
            formatCurrency(monthData.totalTarik),
            formatCurrency(monthData.saldoBulanIni),
            formatCurrency(saldoAkhir)
          ]);
        });
        
        // Add table
        doc.autoTable({
          head: [tableHeaders],
          body: tableData,
          startY: startY,
          styles: { 
            fontSize: 9,
            cellPadding: 3,
            halign: 'center',
            valign: 'middle'
          },
          headStyles: {
            fillColor: [64, 224, 208],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'center'
          },
          columnStyles: {
            0: { cellWidth: 12, halign: 'center' },
            1: { cellWidth: 50, halign: 'left' },
            2: { cellWidth: 30, halign: 'right' },
            3: { cellWidth: 30, halign: 'right' },
            4: { cellWidth: 30, halign: 'right' },
            5: { cellWidth: 30, halign: 'right' }
          },
          margin: { left: 14, right: 14 }
        });
      });
      
      // Save PDF
      doc.save('Rekap_Semua_Data.pdf');
      showNotification('‚úÖ File PDF berhasil diunduh!', 'success');
    }
    

    
    // Set default month and year for unduh page
    function setDefaultUnduhPeriod() {
      const today = new Date();
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (monthFilter) {
        monthFilter.value = today.getMonth().toString();
      }
      if (yearFilter) {
        yearFilter.value = today.getFullYear().toString();
      }
    }
    
    // Handle unduh month change - when "SEMUA DATA" is selected, change year to "SEMUA DATA" too
    function handleUnduhMonthChange() {
      const monthFilter = document.getElementById('unduh-month-filter');
      const yearFilter = document.getElementById('unduh-year-filter');
      
      if (monthFilter && yearFilter) {
        if (monthFilter.value === 'all') {
          yearFilter.value = 'all';
          yearFilter.disabled = true;
          yearFilter.style.opacity = '0.6';
          yearFilter.style.cursor = 'not-allowed';
        } else {
          yearFilter.disabled = false;
          yearFilter.style.opacity = '1';
          yearFilter.style.cursor = 'pointer';
          
          // If year is still "all", change it to current year
          if (yearFilter.value === 'all') {
            const today = new Date();
            yearFilter.value = today.getFullYear().toString();
          }
        }
      }
    }
    
    // Generate XLSX for Riwayat
    function generateRiwayatXLSX(month, year) {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      const monthName = months[month];
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const allStudentNames = studentsList.map(s => s.name);
      
      const transactionMap = {};
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        const transDay = transDate.getDate();
        
        if (transMonth === month && transYear === year) {
          if (!transactionMap[transaction.studentName]) {
            transactionMap[transaction.studentName] = {};
          }
          if (!transactionMap[transaction.studentName][transDay]) {
            transactionMap[transaction.studentName][transDay] = [];
          }
          transactionMap[transaction.studentName][transDay].push(transaction);
        }
      });
      
      let csvContent = `RIWAYAT TRANSAKSI - ${monthName} ${year}\n`;
      csvContent += `Sekolah: ${schoolInfo.schoolName}\n`;
      csvContent += `Kelas: ${schoolInfo.className}\n`;
      csvContent += `Wali Kelas: ${schoolInfo.teacherName}\n\n`;
      
      csvContent += 'NO,NAMA';
      for (let day = 1; day <= daysInMonth; day++) {
        csvContent += `,${day}`;
      }
      csvContent += ',SETOR,TARIK,SALDO BULAN,SALDO AKHIR\n';
      
      allStudentNames.forEach((studentName, index) => {
        let totalSetorBulan = 0;
        let totalTarikBulan = 0;
        
        csvContent += `${index + 1},${studentName}`;
        
        for (let day = 1; day <= daysInMonth; day++) {
          const transactions = transactionMap[studentName]?.[day];
          
          if (transactions && transactions.length > 0) {
            let totalSetor = 0;
            let totalTarik = 0;
            
            transactions.forEach(trans => {
              totalSetor += trans.setor;
              totalTarik += trans.tarik;
              totalSetorBulan += trans.setor;
              totalTarikBulan += trans.tarik;
            });
            
            const netAmount = totalSetor - totalTarik;
            csvContent += `,${netAmount}`;
          } else {
            csvContent += ',0';
          }
        }
        
        const saldoBulan = totalSetorBulan - totalTarikBulan;
        const saldoAkhir = studentBalances[studentName] || 0;
        
        csvContent += `,${totalSetorBulan},${totalTarikBulan},${saldoBulan},${saldoAkhir}\n`;
      });
      
      downloadFile(csvContent, `Riwayat_${monthName}_${year}.csv`, 'text/csv');
      showNotification('‚úÖ File XLSX berhasil diunduh!', 'success');
    }
    
    function generateRiwayatCSV(month, year) {
      generateRiwayatXLSX(month, year);
    }
    
    function generateAllDataRiwayatXLSX() {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      
      const monthYearSet = new Set();
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const key = `${transDate.getFullYear()}-${transDate.getMonth()}`;
        monthYearSet.add(key);
      });
      
      const monthYearArray = Array.from(monthYearSet).map(key => {
        const [year, month] = key.split('-');
        return { year: parseInt(year), month: parseInt(month) };
      }).sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
      
      if (monthYearArray.length === 0) {
        showNotification('‚ùå Tidak ada data transaksi!', 'error');
        return;
      }
      
      let csvContent = `RIWAYAT TRANSAKSI - SEMUA DATA\n`;
      csvContent += `Sekolah: ${schoolInfo.schoolName}\n`;
      csvContent += `Kelas: ${schoolInfo.className}\n`;
      csvContent += `Wali Kelas: ${schoolInfo.teacherName}\n\n`;
      
      const allStudentNames = studentsList.map(s => s.name);
      
      monthYearArray.forEach((monthYear) => {
        const month = monthYear.month;
        const year = monthYear.year;
        const monthName = months[month];
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        csvContent += `\nBULAN: ${monthName} ${year}\n`;
        csvContent += 'NO,NAMA';
        for (let day = 1; day <= daysInMonth; day++) {
          csvContent += `,${day}`;
        }
        csvContent += ',SETOR,TARIK,SALDO BULAN,SALDO AKHIR\n';
        
        const transactionMap = {};
        allTransactions.forEach(transaction => {
          const transDate = new Date(transaction.date);
          const transMonth = transDate.getMonth();
          const transYear = transDate.getFullYear();
          const transDay = transDate.getDate();
          
          if (transMonth === month && transYear === year) {
            if (!transactionMap[transaction.studentName]) {
              transactionMap[transaction.studentName] = {};
            }
            if (!transactionMap[transaction.studentName][transDay]) {
              transactionMap[transaction.studentName][transDay] = [];
            }
            transactionMap[transaction.studentName][transDay].push(transaction);
          }
        });
        
        allStudentNames.forEach((studentName, index) => {
          let totalSetorBulan = 0;
          let totalTarikBulan = 0;
          
          csvContent += `${index + 1},${studentName}`;
          
          for (let day = 1; day <= daysInMonth; day++) {
            const transactions = transactionMap[studentName]?.[day];
            
            if (transactions && transactions.length > 0) {
              let totalSetor = 0;
              let totalTarik = 0;
              
              transactions.forEach(trans => {
                totalSetor += trans.setor;
                totalTarik += trans.tarik;
                totalSetorBulan += trans.setor;
                totalTarikBulan += trans.tarik;
              });
              
              const netAmount = totalSetor - totalTarik;
              csvContent += `,${netAmount}`;
            } else {
              csvContent += ',0';
            }
          }
          
          const saldoBulan = totalSetorBulan - totalTarikBulan;
          const saldoAkhir = studentBalances[studentName] || 0;
          
          csvContent += `,${totalSetorBulan},${totalTarikBulan},${saldoBulan},${saldoAkhir}\n`;
        });
      });
      
      downloadFile(csvContent, 'Riwayat_Semua_Data.csv', 'text/csv');
      showNotification('‚úÖ File XLSX berhasil diunduh!', 'success');
    }
    
    function generateAllDataRiwayatCSV() {
      generateAllDataRiwayatXLSX();
    }
    
    function generateRekapXLSX(month, year) {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      const monthName = months[month];
      
      const allStudentNames = studentsList.map(s => s.name);
      
      const studentMonthTotals = {};
      
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        if (!studentMonthTotals[transaction.studentName]) {
          studentMonthTotals[transaction.studentName] = {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
        }
        
        if (transMonth === month && transYear === year) {
          studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
          studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
          // Use the last transaction's saldo as saldo bulan ini
          studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
        }
      });
      
      let csvContent = `REKAP TRANSAKSI - ${monthName} ${year}\n`;
      csvContent += `Sekolah: ${schoolInfo.schoolName}\n`;
      csvContent += `Kelas: ${schoolInfo.className}\n`;
      csvContent += `Wali Kelas: ${schoolInfo.teacherName}\n\n`;
      csvContent += 'NO,NAMA SISWA,TOTAL SETOR,TOTAL TARIK,SALDO BULAN INI,SALDO AKHIR\n';
      
      allStudentNames.forEach((studentName, index) => {
        const monthData = studentMonthTotals[studentName] || {
          totalSetor: 0,
          totalTarik: 0,
          saldoBulanIni: 0
        };
        
        const saldoAkhir = studentBalances[studentName] || 0;
        
        csvContent += `${index + 1},${studentName},${monthData.totalSetor},${monthData.totalTarik},${monthData.saldoBulanIni},${saldoAkhir}\n`;
      });
      
      downloadFile(csvContent, `Rekap_${monthName}_${year}.csv`, 'text/csv');
      showNotification('‚úÖ File XLSX berhasil diunduh!', 'success');
    }
    
    function generateRekapCSV(month, year) {
      generateRekapXLSX(month, year);
    }
    
    function generateAllDataRekapXLSX() {
      const months = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER'];
      
      const monthYearSet = new Set();
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const key = `${transDate.getFullYear()}-${transDate.getMonth()}`;
        monthYearSet.add(key);
      });
      
      const monthYearArray = Array.from(monthYearSet).map(key => {
        const [year, month] = key.split('-');
        return { year: parseInt(year), month: parseInt(month) };
      }).sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
      
      if (monthYearArray.length === 0) {
        showNotification('‚ùå Tidak ada data transaksi!', 'error');
        return;
      }
      
      let csvContent = `REKAP TRANSAKSI - SEMUA DATA\n`;
      csvContent += `Sekolah: ${schoolInfo.schoolName}\n`;
      csvContent += `Kelas: ${schoolInfo.className}\n`;
      csvContent += `Wali Kelas: ${schoolInfo.teacherName}\n\n`;
      
      const allStudentNames = studentsList.map(s => s.name);
      
      monthYearArray.forEach((monthYear) => {
        const month = monthYear.month;
        const year = monthYear.year;
        const monthName = months[month];
        
        csvContent += `\nBULAN: ${monthName} ${year}\n`;
        csvContent += 'NO,NAMA SISWA,TOTAL SETOR,TOTAL TARIK,SALDO BULAN INI,SALDO AKHIR\n';
        
        const studentMonthTotals = {};
        
        allTransactions.forEach(transaction => {
          const transDate = new Date(transaction.date);
          const transMonth = transDate.getMonth();
          const transYear = transDate.getFullYear();
          
          if (!studentMonthTotals[transaction.studentName]) {
            studentMonthTotals[transaction.studentName] = {
              totalSetor: 0,
              totalTarik: 0,
              saldoBulanIni: 0
            };
          }
          
          if (transMonth === month && transYear === year) {
            studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
            studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
            // Use the last transaction's saldo as saldo bulan ini
            studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
          }
        });
        
        allStudentNames.forEach((studentName, index) => {
          const monthData = studentMonthTotals[studentName] || {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
          
          const saldoAkhir = studentBalances[studentName] || 0;
          
          csvContent += `${index + 1},${studentName},${monthData.totalSetor},${monthData.totalTarik},${monthData.saldoBulanIni},${saldoAkhir}\n`;
        });
      });
      
      downloadFile(csvContent, 'Rekap_Semua_Data.csv', 'text/csv');
      showNotification('‚úÖ File XLSX berhasil diunduh!', 'success');
    }
    
    function generateAllDataRekapCSV() {
      generateAllDataRekapXLSX();
    }
    
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      // Show cool download success notification
      showDownloadSuccessNotification(filename);
    }
    
    function showDownloadSuccessNotification(filename) {
      // Create notification overlay
      const notifOverlay = document.createElement('div');
      notifOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      `;
      
      // Create notification card
      const notifCard = document.createElement('div');
      notifCard.style.cssText = `
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        border-radius: 16px;
        padding: 30px 24px;
        max-width: 300px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        color: white;
        text-align: center;
        animation: slideUp 0.4s ease;
        position: relative;
        overflow: hidden;
      `;
      
      // Add animated background circles
      notifCard.innerHTML = `
        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: pulse 2s ease-in-out infinite;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: pulse 2s ease-in-out infinite 0.5s;"></div>
        
        <div style="position: relative; z-index: 1;">
          <div style="margin-bottom: 16px; animation: bounceIn 0.6s ease;">
            <div style="font-size: 56px; margin-bottom: 8px; animation: checkmark 0.8s ease;">‚úì</div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <div style="font-size: 20px; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
              BERHASIL!
            </div>
            <div style="font-size: 13px; opacity: 0.95; line-height: 1.5; font-weight: 600;">
              File berhasil diunduh
            </div>
          </div>
          
          <div style="background: rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 20px; backdrop-filter: blur(10px);">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 6px; font-weight: 600;">NAMA FILE:</div>
            <div style="font-size: 13px; font-weight: 700; word-break: break-all; line-height: 1.4;">
              ${filename}
            </div>
          </div>
          
          <button id="download-notif-close-btn" style="
            width: 100%;
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(10px);
          ">
            TUTUP
          </button>
        </div>
      `;
      
      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        
        @keyframes slideUp {
          from {
            transform: translateY(30px) scale(0.9);
            opacity: 0;
          }
          to {
            transform: translateY(0) scale(1);
            opacity: 1;
          }
        }
        
        @keyframes bounceIn {
          0% {
            transform: scale(0);
            opacity: 0;
          }
          50% {
            transform: scale(1.1);
          }
          100% {
            transform: scale(1);
            opacity: 1;
          }
        }
        
        @keyframes checkmark {
          0% {
            transform: scale(0) rotate(-45deg);
            opacity: 0;
          }
          50% {
            transform: scale(1.2) rotate(10deg);
          }
          100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
          }
        }
        
        @keyframes pulse {
          0%, 100% {
            transform: scale(1);
            opacity: 0.3;
          }
          50% {
            transform: scale(1.1);
            opacity: 0.5;
          }
        }
      `;
      document.head.appendChild(style);
      
      notifOverlay.appendChild(notifCard);
      document.body.appendChild(notifOverlay);
      
      // Add hover effect to button
      const closeBtn = notifCard.querySelector('#download-notif-close-btn');
      closeBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255, 255, 255, 0.35)';
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.3)';
      });
      closeBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255, 255, 255, 0.25)';
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
      });
      
      // Handle close button click
      closeBtn.addEventListener('click', function() {
        notifOverlay.style.animation = 'fadeOut 0.3s ease';
        notifCard.style.animation = 'slideDown 0.3s ease';
        
        setTimeout(() => {
          if (document.body.contains(notifOverlay)) {
            document.body.removeChild(notifOverlay);
          }
          if (document.head.contains(style)) {
            document.head.removeChild(style);
          }
        }, 300);
      });
      
      // Close on overlay click
      notifOverlay.addEventListener('click', function(e) {
        if (e.target === notifOverlay) {
          closeBtn.click();
        }
      });
      
      // Auto close after 4 seconds
      setTimeout(() => {
        if (document.body.contains(notifOverlay)) {
          closeBtn.click();
        }
      }, 4000);
    }
    
    // Set default month and year for kirim page
    function setDefaultKirimPeriod() {
      const today = new Date();
      const monthFilter = document.getElementById('kirim-month-filter');
      const yearFilter = document.getElementById('kirim-year-filter');
      
      if (monthFilter) {
        monthFilter.value = today.getMonth().toString();
      }
      if (yearFilter) {
        yearFilter.value = today.getFullYear().toString();
      }
      
      // Show welcome notification
      showKirimWelcomeNotification();
    }
    
    // Show Pengaturan modal
    function showPengaturan() {
      const modal = document.getElementById('settingsModal');
      modal.classList.add('active');
      
      // Load saved color preference
      loadColorPreference();
    }
    
    // Close settings modal
    function closeSettingsModal() {
      const modal = document.getElementById('settingsModal');
      modal.classList.remove('active');
    }
    
    // Change app color
    function changeAppColor(primaryColor, accentColor, colorName) {
      // Save color preference to localStorage
      const colorPreference = {
        primary: primaryColor,
        accent: accentColor,
        name: colorName
      };
      localStorage.setItem('appColorPreference', JSON.stringify(colorPreference));
      
      // Apply color immediately
      applyColorTheme(primaryColor, accentColor, colorName);
      
      // Show success notification
      showNotification(`‚úÖ Tema ${colorName} berhasil diterapkan!`, 'success');
    }
    
    // Apply color theme to the app
    function applyColorTheme(primaryColor, accentColor, colorName) {
      const container = document.querySelector('.mobile-container');
      if (container) {
        container.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
      }
      
      // Update active color indicator
      const activeColorName = document.getElementById('active-color-name');
      if (activeColorName) {
        activeColorName.textContent = colorName;
      }
      
      // Update checkmarks
      document.querySelectorAll('[id^="check-"]').forEach(check => {
        check.style.display = 'none';
      });
      
      // Show checkmark for selected color
      const colorMap = {
        'Hijau Tosca': 'check-tosca',
        'Biru Langit': 'check-biru',
        'Pink Baby': 'check-pink',
        'Hitam': 'check-hitam',
        'Kuning': 'check-kuning'
      };
      
      const checkId = colorMap[colorName];
      if (checkId) {
        const checkmark = document.getElementById(checkId);
        if (checkmark) {
          checkmark.style.display = 'block';
        }
      }
    }
    
    // Load color preference from localStorage
    function loadColorPreference() {
      const savedColor = localStorage.getItem('appColorPreference');
      if (savedColor) {
        const colorPreference = JSON.parse(savedColor);
        applyColorTheme(colorPreference.primary, colorPreference.accent, colorPreference.name);
      } else {
        // Default to Hijau Tosca
        applyColorTheme('#40E0D0', '#48D1CC', 'Hijau Tosca');
      }
    }
    
    // Close modal when clicking outside
    document.getElementById('settingsModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeSettingsModal();
      }
    });
    
    // Hapus Semua Data function
    function hapusSemuaData() {
      // Create confirmation overlay
      const confirmOverlay = document.createElement('div');
      confirmOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 3000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      `;
      
      const confirmCard = document.createElement('div');
      confirmCard.style.cssText = `
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 16px;
        padding: 24px;
        max-width: 320px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        color: white;
        text-align: center;
        animation: slideUp 0.3s ease;
      `;
      
      confirmCard.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <div style="font-size: 18px; font-weight: 800; margin-bottom: 12px; letter-spacing: 0.5px;">PERINGATAN!</div>
        <div style="font-size: 14px; opacity: 0.95; line-height: 1.6; margin-bottom: 20px; background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px;">
          Apakah Anda yakin ingin menghapus <strong>SEMUA DATA</strong>?<br><br>
          Data yang akan dihapus:<br>
          ‚Ä¢ Informasi Sekolah<br>
          ‚Ä¢ Daftar Siswa<br>
          ‚Ä¢ Semua Transaksi<br>
          ‚Ä¢ Saldo Siswa<br><br>
          <strong>Tindakan ini tidak dapat dibatalkan!</strong>
        </div>
        <div style="display: flex; gap: 10px;">
          <button id="cancel-delete-btn" style="flex: 1; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 8px; padding: 12px; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
            BATAL
          </button>
          <button id="confirm-delete-btn" style="flex: 1; background: rgba(255, 255, 255, 0.9); border: 2px solid #ffffff; border-radius: 8px; padding: 12px; color: #ef4444; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
            HAPUS
          </button>
        </div>
      `;
      
      confirmOverlay.appendChild(confirmCard);
      document.body.appendChild(confirmOverlay);
      
      // Cancel button
      document.getElementById('cancel-delete-btn').addEventListener('click', function() {
        document.body.removeChild(confirmOverlay);
      });
      
      // Confirm delete button
      document.getElementById('confirm-delete-btn').addEventListener('click', function() {
        // Clear all data
        schoolInfo = {
          schoolName: '-',
          className: '-',
          teacherName: '-'
        };
        studentsList = [];
        allTransactions = [];
        studentBalances = {};
        
        // Clear localStorage
        localStorage.removeItem('schoolInfo');
        localStorage.removeItem('studentsList');
        localStorage.removeItem('allTransactions');
        localStorage.removeItem('studentBalances');
        
        // Close confirmation
        document.body.removeChild(confirmOverlay);
        
        // Close settings modal
        closeSettingsModal();
        
        // Show success notification
        showNotification('‚úÖ Semua data berhasil dihapus!', 'success');
        
        // Refresh current page if on data-related pages
        if (currentPage === 'siswa' || currentPage === 'transaksi' || currentPage === 'saldo' || currentPage === 'laporan') {
          showPage(currentPage);
        }
      });
      
      // Close on overlay click
      confirmOverlay.addEventListener('click', function(e) {
        if (e.target === confirmOverlay) {
          document.body.removeChild(confirmOverlay);
        }
      });
    }
    
    // Backup Data function
    function backupData() {
      // Prepare backup data
      const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        schoolInfo: schoolInfo,
        studentsList: studentsList,
        allTransactions: allTransactions,
        studentBalances: studentBalances
      };
      
      // Convert to JSON
      const jsonData = JSON.stringify(backupData, null, 2);
      
      // Create filename with timestamp
      const now = new Date();
      const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
      const timeStr = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
      const filename = `Backup_Tabungan_${dateStr}_${timeStr}.json`;
      
      // Download file
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      // Show success notification
      showDownloadSuccessNotification(filename);
    }
    
    // Restore Data function
    function restoreData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Check file type
      if (!file.name.endsWith('.json')) {
        showNotification('‚ùå File harus berformat JSON!', 'error');
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const backupData = JSON.parse(e.target.result);
          
          // Validate backup data structure
          if (!backupData.version || !backupData.schoolInfo || !backupData.studentsList || !backupData.allTransactions || !backupData.studentBalances) {
            showNotification('‚ùå Format file backup tidak valid!', 'error');
            return;
          }
          
          // Create confirmation overlay
          const confirmOverlay = document.createElement('div');
          confirmOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
          `;
          
          const confirmCard = document.createElement('div');
          confirmCard.style.cssText = `
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            color: white;
            text-align: center;
            animation: slideUp 0.3s ease;
          `;
          
          // Format backup timestamp
          const backupDate = new Date(backupData.timestamp);
          const dateStr = backupDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
          const timeStr = backupDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
          
          confirmCard.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 16px;">üì•</div>
            <div style="font-size: 18px; font-weight: 800; margin-bottom: 12px; letter-spacing: 0.5px;">RESTORE DATA</div>
            <div style="font-size: 14px; opacity: 0.95; line-height: 1.6; margin-bottom: 20px; background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px; text-align: left;">
              <strong>File Backup:</strong><br>
              ${file.name}<br><br>
              <strong>Tanggal Backup:</strong><br>
              ${dateStr}<br>
              ${timeStr}<br><br>
              <strong>Data yang akan di-restore:</strong><br>
              ‚Ä¢ ${backupData.studentsList.length} Siswa<br>
              ‚Ä¢ ${backupData.allTransactions.length} Transaksi<br><br>
              <strong style="color: #ffeb3b;">‚ö†Ô∏è Data saat ini akan diganti!</strong>
            </div>
            <div style="display: flex; gap: 10px;">
              <button id="cancel-restore-btn" style="flex: 1; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 8px; padding: 12px; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                BATAL
              </button>
              <button id="confirm-restore-btn" style="flex: 1; background: rgba(255, 255, 255, 0.9); border: 2px solid #ffffff; border-radius: 8px; padding: 12px; color: #22c55e; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                RESTORE
              </button>
            </div>
          `;
          
          confirmOverlay.appendChild(confirmCard);
          document.body.appendChild(confirmOverlay);
          
          // Cancel button
          document.getElementById('cancel-restore-btn').addEventListener('click', function() {
            document.body.removeChild(confirmOverlay);
          });
          
          // Confirm restore button
          document.getElementById('confirm-restore-btn').addEventListener('click', function() {
            // Restore data
            schoolInfo = backupData.schoolInfo;
            studentsList = backupData.studentsList;
            allTransactions = backupData.allTransactions;
            studentBalances = backupData.studentBalances;
            
            // Save to localStorage
            savePersistedData();
            
            // Close confirmation
            document.body.removeChild(confirmOverlay);
            
            // Close settings modal
            closeSettingsModal();
            
            // Show success notification
            showNotification('‚úÖ Data berhasil di-restore!', 'success');
            
            // Refresh current page if on data-related pages
            if (currentPage === 'siswa' || currentPage === 'transaksi' || currentPage === 'saldo' || currentPage === 'laporan') {
              showPage(currentPage);
            }
          });
          
          // Close on overlay click
          confirmOverlay.addEventListener('click', function(e) {
            if (e.target === confirmOverlay) {
              document.body.removeChild(confirmOverlay);
            }
          });
          
        } catch (error) {
          showNotification('‚ùå Error membaca file backup: ' + error.message, 'error');
        }
      };
      
      reader.onerror = function() {
        showNotification('‚ùå Gagal membaca file!', 'error');
      };
      
      reader.readAsText(file);
      
      // Reset file input
      event.target.value = '';
    }
    
    // Show Keluar confirmation
    function showKeluar() {
      // Create confirmation overlay
      const confirmOverlay = document.createElement('div');
      confirmOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 3000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      `;
      
      const confirmCard = document.createElement('div');
      confirmCard.style.cssText = `
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 16px;
        padding: 24px;
        max-width: 320px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        color: white;
        text-align: center;
        animation: slideUp 0.3s ease;
      `;
      
      confirmCard.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">‚ûú</div>
        <div style="font-size: 18px; font-weight: 800; margin-bottom: 12px; letter-spacing: 0.5px;">KELUAR APLIKASI</div>
        <div style="font-size: 14px; opacity: 0.95; line-height: 1.6; margin-bottom: 20px; background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px;">
          Apakah Anda yakin ingin keluar dari aplikasi?<br><br>
          <strong>Data Anda akan tetap tersimpan</strong>
        </div>
        <div style="display: flex; gap: 10px;">
          <button id="cancel-exit-btn" style="flex: 1; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 8px; padding: 12px; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
            BATAL
          </button>
          <button id="confirm-exit-btn" style="flex: 1; background: rgba(255, 255, 255, 0.9); border: 2px solid #ffffff; border-radius: 8px; padding: 12px; color: #ef4444; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
            KELUAR
          </button>
        </div>
      `;
      
      confirmOverlay.appendChild(confirmCard);
      document.body.appendChild(confirmOverlay);
      
      // Cancel button
      document.getElementById('cancel-exit-btn').addEventListener('click', function() {
        document.body.removeChild(confirmOverlay);
      });
      
      // Confirm exit button
      document.getElementById('confirm-exit-btn').addEventListener('click', function() {
        // Close the window/tab
        window.close();
        
        // If window.close() doesn't work (some browsers block it), show a message
        setTimeout(() => {
          if (!window.closed) {
            document.body.removeChild(confirmOverlay);
            
            // Show message that user needs to close manually
            const exitMessage = document.createElement('div');
            exitMessage.style.cssText = `
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
              color: white;
              padding: 24px 28px;
              border-radius: 16px;
              font-size: 16px;
              font-weight: 600;
              z-index: 3000;
              backdrop-filter: blur(10px);
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
              text-align: center;
              max-width: 300px;
              animation: slideUp 0.3s ease;
            `;
            exitMessage.innerHTML = `
              <div style="font-size: 36px; margin-bottom: 12px;">‚ÑπÔ∏è</div>
              <div style="font-size: 16px; font-weight: 800; margin-bottom: 8px; letter-spacing: 0.5px;">INFORMASI</div>
              <div style="font-size: 14px; opacity: 0.95; line-height: 1.6;">
                Silakan tutup tab/jendela browser ini secara manual untuk keluar dari aplikasi
              </div>
            `;
            document.body.appendChild(exitMessage);
            
            setTimeout(() => {
              if (document.body.contains(exitMessage)) {
                document.body.removeChild(exitMessage);
              }
            }, 4000);
          }
        }, 100);
      });
      
      // Close on overlay click
      confirmOverlay.addEventListener('click', function(e) {
        if (e.target === confirmOverlay) {
          document.body.removeChild(confirmOverlay);
        }
      });
    }
    
    // Show welcome notification for Kirim page
    function showKirimWelcomeNotification() {
      // Create notification overlay
      const notifOverlay = document.createElement('div');
      notifOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      `;
      
      // Create notification card
      const notifCard = document.createElement('div');
      notifCard.style.cssText = `
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 16px;
        padding: 30px 24px;
        max-width: 320px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        color: white;
        text-align: center;
        animation: slideUp 0.4s ease;
        position: relative;
        overflow: hidden;
      `;
      
      // Add animated background circles
      notifCard.innerHTML = `
        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: pulse 2s ease-in-out infinite;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: pulse 2s ease-in-out infinite 0.5s;"></div>
        
        <div style="position: relative; z-index: 1;">
          <div style="margin-bottom: 16px; animation: bounceIn 0.6s ease;">
            <div style="font-size: 48px; margin-bottom: 8px;">üìß</div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-size: 18px; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 12px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">
              SELAMAT DATANG
            </div>
            <div style="font-size: 14px; opacity: 0.95; line-height: 1.6; font-weight: 500; text-align: left; background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 10px; backdrop-filter: blur(10px);">
              Di halaman ini Anda dapat mengirimkan laporan tabungan siswa kepada orang tua melalui <strong>Email</strong> atau <strong>WhatsApp</strong>
            </div>
          </div>
        </div>
      `;
      
      notifOverlay.appendChild(notifCard);
      document.body.appendChild(notifOverlay);
      
      // Auto close after 3 seconds
      setTimeout(() => {
        notifOverlay.style.animation = 'fadeOut 0.3s ease';
        notifCard.style.animation = 'slideDown 0.3s ease';
        
        setTimeout(() => {
          if (document.body.contains(notifOverlay)) {
            document.body.removeChild(notifOverlay);
          }
        }, 300);
      }, 3000);
      
      // Close on overlay click
      notifOverlay.addEventListener('click', function(e) {
        if (e.target === notifOverlay) {
          notifOverlay.style.animation = 'fadeOut 0.3s ease';
          notifCard.style.animation = 'slideDown 0.3s ease';
          
          setTimeout(() => {
            if (document.body.contains(notifOverlay)) {
              document.body.removeChild(notifOverlay);
            }
          }, 300);
        }
      });
    }
    
    // Handle kirim month change - when "SEMUA DATA" is selected, change year to "SEMUA DATA" too
    function handleKirimMonthChange() {
      const monthFilter = document.getElementById('kirim-month-filter');
      const yearFilter = document.getElementById('kirim-year-filter');
      
      if (monthFilter && yearFilter) {
        if (monthFilter.value === 'all') {
          yearFilter.value = 'all';
          yearFilter.disabled = true;
          yearFilter.style.opacity = '0.6';
          yearFilter.style.cursor = 'not-allowed';
        } else {
          yearFilter.disabled = false;
          yearFilter.style.opacity = '1';
          yearFilter.style.cursor = 'pointer';
          
          // If year is still "all", change it to current year
          if (yearFilter.value === 'all') {
            const today = new Date();
            yearFilter.value = today.getFullYear().toString();
          }
        }
      }
    }
    
    // Kirim via Email
    function kirimViaEmail() {
      const monthFilter = document.getElementById('kirim-month-filter');
      const yearFilter = document.getElementById('kirim-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      let subject = '';
      let emailBody = '';
      
      // Check if "SEMUA DATA" is selected
      if (selectedMonth === 'all' && selectedYear === 'all') {
        subject = `Laporan Tabungan Siswa - Semua Data`;
        
        emailBody = `NAMA SEKOLAH : ${schoolInfo.schoolName}\n`;
        emailBody += `KELAS : ${schoolInfo.className}\n`;
        emailBody += `NAMA WALI KELAS : ${schoolInfo.teacherName}\n\n`;
        emailBody += `=== REKAP TABUNGAN : SEMUA DATA ===\n\n`;
      } else {
        const monthName = months[parseInt(selectedMonth)].toUpperCase();
        subject = `Laporan Tabungan Siswa - ${monthName} ${selectedYear}`;
        
        emailBody = `NAMA SEKOLAH : ${schoolInfo.schoolName}\n`;
        emailBody += `KELAS : ${schoolInfo.className}\n`;
        emailBody += `NAMA WALI KELAS : ${schoolInfo.teacherName}\n\n`;
        emailBody += `=== REKAP TABUNGAN : ${monthName} ${selectedYear} ===\n\n`;
      }
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      // Calculate totals per student
      const studentMonthTotals = {};
      
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        if (!studentMonthTotals[transaction.studentName]) {
          studentMonthTotals[transaction.studentName] = {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
        }
        
        // If "SEMUA DATA" is selected, include all transactions
        if (selectedMonth === 'all' && selectedYear === 'all') {
          studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
          studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
          studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
        } else {
          // Otherwise, filter by selected month and year
          if (transMonth === parseInt(selectedMonth) && transYear === parseInt(selectedYear)) {
            studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
            studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
            studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
          }
        }
      });
      
      // Add student data to email
      allStudentNames.forEach((studentName, index) => {
        const monthData = studentMonthTotals[studentName] || {
          totalSetor: 0,
          totalTarik: 0,
          saldoBulanIni: 0
        };
        
        const saldoAkhir = studentBalances[studentName] || 0;
        
        emailBody += `${index + 1}. ${studentName}\n`;
        emailBody += `Setor : ${formatCurrency(monthData.totalSetor)}\n`;
        emailBody += `Tarik : ${formatCurrency(monthData.totalTarik)}\n`;
        
        // For "SEMUA DATA", only show Saldo Akhir (no Saldo Bulan Ini)
        if (selectedMonth === 'all' && selectedYear === 'all') {
          emailBody += `Saldo Akhir : ${formatCurrency(saldoAkhir)}\n\n`;
        } else {
          emailBody += `Saldo Bulan Ini : ${formatCurrency(monthData.saldoBulanIni)}\n`;
          emailBody += `Saldo Akhir : ${formatCurrency(saldoAkhir)}\n\n`;
        }
      });
      
      emailBody += `Laporan rekap ini dibuat oleh Aplikasi Tabungan Digital`;
      
      // Encode subject and body for mailto link
      const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
      
      // Open email client
      window.open(mailtoLink, '_blank');
      
      showNotification('‚úÖ Membuka aplikasi email...', 'success');
    }
    
    // Kirim via WhatsApp
    function kirimViaWhatsApp() {
      const monthFilter = document.getElementById('kirim-month-filter');
      const yearFilter = document.getElementById('kirim-year-filter');
      
      if (!monthFilter || !yearFilter) return;
      
      const selectedMonth = monthFilter.value;
      const selectedYear = yearFilter.value;
      
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      let waMessage = '';
      
      // Check if "SEMUA DATA" is selected
      if (selectedMonth === 'all' && selectedYear === 'all') {
        waMessage = `*NAMA SEKOLAH :* ${schoolInfo.schoolName}\n`;
        waMessage += `*KELAS :* ${schoolInfo.className}\n`;
        waMessage += `*NAMA WALI KELAS :* ${schoolInfo.teacherName}\n\n`;
        waMessage += `*=== REKAP TABUNGAN : SEMUA DATA ===*\n\n`;
      } else {
        const monthName = months[parseInt(selectedMonth)].toUpperCase();
        waMessage = `*NAMA SEKOLAH :* ${schoolInfo.schoolName}\n`;
        waMessage += `*KELAS :* ${schoolInfo.className}\n`;
        waMessage += `*NAMA WALI KELAS :* ${schoolInfo.teacherName}\n\n`;
        waMessage += `*=== REKAP TABUNGAN : ${monthName} ${selectedYear} ===*\n\n`;
      }
      
      // Get all students
      const allStudentNames = studentsList.map(s => s.name);
      
      // Calculate totals per student
      const studentMonthTotals = {};
      
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        if (!studentMonthTotals[transaction.studentName]) {
          studentMonthTotals[transaction.studentName] = {
            totalSetor: 0,
            totalTarik: 0,
            saldoBulanIni: 0
          };
        }
        
        // If "SEMUA DATA" is selected, include all transactions
        if (selectedMonth === 'all' && selectedYear === 'all') {
          studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
          studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
          studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
        } else {
          // Otherwise, filter by selected month and year
          if (transMonth === parseInt(selectedMonth) && transYear === parseInt(selectedYear)) {
            studentMonthTotals[transaction.studentName].totalSetor += transaction.setor;
            studentMonthTotals[transaction.studentName].totalTarik += transaction.tarik;
            studentMonthTotals[transaction.studentName].saldoBulanIni = transaction.saldo;
          }
        }
      });
      
      // Add student data to WhatsApp message
      allStudentNames.forEach((studentName, index) => {
        const monthData = studentMonthTotals[studentName] || {
          totalSetor: 0,
          totalTarik: 0,
          saldoBulanIni: 0
        };
        
        const saldoAkhir = studentBalances[studentName] || 0;
        
        waMessage += `*${index + 1}. ${studentName}*\n`;
        waMessage += `Setor : ${formatCurrency(monthData.totalSetor)}\n`;
        waMessage += `Tarik : ${formatCurrency(monthData.totalTarik)}\n`;
        
        // For "SEMUA DATA", only show Saldo Akhir (no Saldo Bulan Ini)
        if (selectedMonth === 'all' && selectedYear === 'all') {
          waMessage += `Saldo Akhir : ${formatCurrency(saldoAkhir)}\n\n`;
        } else {
          waMessage += `Saldo Bulan Ini : ${formatCurrency(monthData.saldoBulanIni)}\n`;
          waMessage += `Saldo Akhir : ${formatCurrency(saldoAkhir)}\n\n`;
        }
      });
      
      waMessage += `_Laporan rekap ini dibuat oleh Aplikasi Tabungan Digital_`;
      
      // Encode message for WhatsApp link
      const waLink = `https://wa.me/?text=${encodeURIComponent(waMessage)}`;
      
      // Open WhatsApp
      window.open(waLink, '_blank');
      
      showNotification('‚úÖ Membuka WhatsApp...', 'success');
    }
    
    // Calculate and display saldo statistics
    function calculateAndDisplaySaldo() {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Format date display
      const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const dayName = days[today.getDay()];
      const day = today.getDate();
      const monthName = months[today.getMonth()];
      const year = today.getFullYear();
      const dateDisplay = `${dayName}, ${day} ${monthName} ${year}`;
      
      // Update date display
      const dateDisplayEl = document.getElementById('saldo-date-display');
      if (dateDisplayEl) {
        dateDisplayEl.textContent = dateDisplay;
      }
      
      // Initialize counters
      let setorToday = 0;
      let tarikToday = 0;
      let setorMonth = 0;
      let tarikMonth = 0;
      let transactionCountMonth = 0;
      let setorTotal = 0;
      let tarikTotal = 0;
      
      // Calculate from all transactions
      allTransactions.forEach(transaction => {
        const transDate = new Date(transaction.date);
        const transMonth = transDate.getMonth();
        const transYear = transDate.getFullYear();
        
        // Today's transactions
        if (transaction.date === todayStr) {
          setorToday += transaction.setor;
          tarikToday += transaction.tarik;
        }
        
        // This month's transactions
        if (transMonth === currentMonth && transYear === currentYear) {
          setorMonth += transaction.setor;
          tarikMonth += transaction.tarik;
          transactionCountMonth++;
        }
        
        // Total transactions
        setorTotal += transaction.setor;
        tarikTotal += transaction.tarik;
      });
      
      // Count active students (students with balance > 0)
      let activeStudents = 0;
      Object.values(studentBalances).forEach(balance => {
        if (balance > 0) {
          activeStudents++;
        }
      });
      
      // Calculate saldo amounts
      const saldoToday = setorToday - tarikToday;
      const saldoMonth = setorMonth - tarikMonth;
      const saldoTotal = setorTotal - tarikTotal;
      
      // Update display
      const setorTodayEl = document.getElementById('setor-today');
      const tarikTodayEl = document.getElementById('tarik-today');
      const saldoTodayEl = document.getElementById('saldo-today');
      const setorMonthEl = document.getElementById('setor-month');
      const tarikMonthEl = document.getElementById('tarik-month');
      const saldoMonthEl = document.getElementById('saldo-month');
      const transactionCountMonthEl = document.getElementById('transaction-count-month');
      const setorTotalEl = document.getElementById('setor-total');
      const tarikTotalEl = document.getElementById('tarik-total');
      const saldoTotalEl = document.getElementById('saldo-total');
      const activeStudentsEl = document.getElementById('active-students');
      
      if (setorTodayEl) setorTodayEl.textContent = formatCurrency(setorToday);
      if (tarikTodayEl) tarikTodayEl.textContent = formatCurrency(tarikToday);
      if (saldoTodayEl) saldoTodayEl.textContent = formatCurrency(saldoToday);
      if (setorMonthEl) setorMonthEl.textContent = formatCurrency(setorMonth);
      if (tarikMonthEl) tarikMonthEl.textContent = formatCurrency(tarikMonth);
      if (saldoMonthEl) saldoMonthEl.textContent = formatCurrency(saldoMonth);
      if (transactionCountMonthEl) transactionCountMonthEl.textContent = transactionCountMonth;
      if (setorTotalEl) setorTotalEl.textContent = formatCurrency(setorTotal);
      if (tarikTotalEl) tarikTotalEl.textContent = formatCurrency(tarikTotal);
      if (saldoTotalEl) saldoTotalEl.textContent = formatCurrency(saldoTotal);
      if (activeStudentsEl) activeStudentsEl.textContent = activeStudents + ' siswa';
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ce7b5ff383e78f',t:'MTc2Mjg3MTM2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>